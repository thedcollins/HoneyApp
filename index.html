<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#b8860b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="HoneyApp">
  <title>HoneyApp</title>
  <style>
    :root { --honey: #d4a017; --honey-dark: #b8860b; --wax: #e8d5a3; --bg: #fefce8; --card: #fffef5; --border: #e6d9a8; --text: #2c2416; --muted: #6b5d4a; }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; min-height: 100vh; padding-bottom: env(safe-area-inset-bottom, 1rem); }
    .screen { display: none; max-width: 720px; margin: 0 auto; }
    .screen.active { display: block; }
    @media (hover: none) and (pointer: coarse) {
      .screen { max-width: none; width: 100%; }
    }
    h1 { color: var(--honey-dark); font-size: 1.5rem; margin: 0 0 0.5rem 0; }
    .help { font-size: 0.85rem; color: var(--muted); margin-top: 0.25rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin: 1rem 0; }
    .btn { background: var(--honey-dark); color: #fff; border: none; padding: 0.65rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; min-height: 44px; width: 100%; margin: 0.4rem 0; }
    .btn:hover { background: var(--honey); }
    .btn.secondary { background: var(--wax); color: var(--text); width: auto; border: 1px solid var(--border); }
    .status { font-size: 0.9rem; color: var(--muted); margin-top: 0.5rem; }
    .status.ok { color: #2d6a2d; }
    .status.err { color: #a52a2a; }
    input[type="text"], input[type="password"] { width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin: 0.25rem 0; }
    label { display: block; font-weight: 600; margin-top: 0.5rem; }
    .tabs { display: flex; gap: 0.2rem; margin-bottom: 1rem; border-bottom: 2px solid var(--border); flex-wrap: wrap; }
    .tabs button { background: none; border: none; padding: 0.5rem 0.8rem; min-height: 40px; cursor: pointer; color: var(--muted); font-weight: 600; border-radius: 6px 6px 0 0; }
    .tabs button.active { color: var(--honey-dark); background: var(--card); border: 1px solid var(--border); border-bottom: none; margin-bottom: -2px; }
    .sheet { display: none; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; }
    .sheet.active { display: block; }
    .settings-layout { display: flex; flex-direction: column; gap: 1rem; }
    @media (min-width: 560px) { .settings-layout { flex-direction: row; align-items: flex-start; } }
    .settings-nav { flex: 0 0 auto; min-width: 140px; padding-right: 1rem; border-right: 1px solid var(--border); }
    .settings-nav button { display: block; width: 100%; text-align: left; background: none; border: none; padding: 0.5rem 0.6rem; margin: 0.2rem 0; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--muted); }
    .settings-nav button:hover { background: var(--wax); color: var(--text); }
    .settings-nav button.active { background: var(--wax); color: var(--honey-dark); }
    .settings-content { flex: 1; min-width: 0; }
    .settings-panel { display: none; padding: 0.5rem 0; }
    .settings-panel.active { display: block; }
    #app-sheet-settings .settings-content .settings-panel:first-child { padding-top: 0; }
    #app-sheet-settings .settings-content .settings-panel:first-child .settings-block { margin-top: 0; }
    #settings_status:empty { display: none; }
    #settings_status:not(:empty) { margin-top: 0.75rem; }
    #admin_status:empty { display: none; }
    .admin-table-wrapper { margin: 0.5rem 0 0.75rem 0; overflow-x: auto; }
    .admin-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; border: 1px solid var(--border); table-layout: fixed; }
    .admin-table th:nth-child(1), .admin-table td:nth-child(1) { width: 40%; }
    .admin-table th:nth-child(2), .admin-table td:nth-child(2) { width: 35%; }
    .admin-table th:nth-child(3), .admin-table td:nth-child(3) { width: 25%; }
    .admin-table th, .admin-table td { padding: 0.5rem 0.6rem; text-align: left; border: 1px solid var(--border); }
    .admin-table th { color: var(--honey-dark); font-weight: 700; background: var(--wax); }
    .admin-table td:nth-child(2), .admin-table td:nth-child(3) { white-space: nowrap; }
    .admin-table td:nth-child(2) .btn, .admin-table td:nth-child(3) .btn { margin: 0; padding: 0.2rem 0; font-weight: 600; color: var(--status-err, #a52a2a); background: transparent; border: none; }
    .admin-table td:nth-child(2) .btn:hover, .admin-table td:nth-child(3) .btn:hover { opacity: 0.85; }
    .admin-table-muted { color: var(--muted); }
    .btn-remove { font-size: 0.8rem; padding: 0.2rem 0.4rem; min-height: auto; background: transparent; color: var(--muted); }
    .btn-remove:hover { color: var(--status-err, #a52a2a); }
    .admin-table .btn-remove { color: var(--honey-dark); }
    .admin-table .btn-remove:hover { color: var(--status-err, #a52a2a); }
    .btn-secondary-small { font-size: 0.8rem; padding: 0.2rem 0.4rem; min-height: auto; }
    .settings-block { margin-top: 1rem; padding: 0.8rem; background: var(--wax); border-radius: 8px; border: 1px solid var(--border); }
    .settings-block h2 { font-size: 1rem; color: var(--honey-dark); margin: 0 0 0.4rem 0; }
    .password-wrapper { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
    .password-wrapper.active { display: flex; }
    .password-wrapper .card { max-width: 360px; margin: 0; }
    .tasks-new-task-wrapper { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
    .tasks-new-task-wrapper.active { display: flex; }
    .tasks-new-task-wrapper .card { max-width: 420px; margin: 0; width: 100%; }
    .tasks-new-task-wrapper .tasks-form-wrap { margin-bottom: 0; }
    .tasks-new-task-wrapper .tasks-date-row { padding-right: 0; }
    .tasks-new-task-wrapper .tasks-repeat-row { flex-wrap: nowrap; align-items: flex-start; }
    .tasks-new-task-wrapper .tasks-repeat-row .tasks-field-repeat { flex: 1 1 100%; width: 100%; min-width: 0; }
    .tasks-new-task-wrapper .tasks-repeat-row:has(#tasks-repeat-custom-wrap[style*="display: flex"]) .tasks-field-repeat { flex: 0 0 8rem; width: 8rem; max-width: 8rem; min-width: 0; }
    .tasks-new-task-wrapper .tasks-repeat-row #tasks-repeat-custom-wrap { flex: 1 1 0; min-width: 0; flex-direction: column; align-items: flex-start; gap: 0 0.5rem; }
    .tasks-new-task-wrapper .tasks-repeat-row #tasks-repeat-custom-wrap label { margin: 0; font-weight: 600; line-height: 1.25; }
    .tasks-new-task-wrapper .tasks-repeat-row .tasks-repeat-custom-inner { margin-top: 0.25rem; }
    .tasks-new-task-wrapper .tasks-repeat-row .tasks-repeat-custom-inner input,
    .tasks-new-task-wrapper .tasks-repeat-row .tasks-repeat-custom-inner select { height: 2.5rem; min-height: 2.5rem; max-height: 2.5rem; box-sizing: border-box; }
    .calendar-new-event-wrapper { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
    .calendar-new-event-wrapper.active { display: flex; }
    .calendar-new-event-wrapper .card { max-width: 420px; margin: 0; width: 100%; max-height: 90vh; overflow: auto; }
    .calendar-new-event-wrapper .calendar-event-form { margin-bottom: 0; }
    .calendar-new-event-wrapper .calendar-event-repeat-row { align-items: flex-start; }
    .calendar-new-event-wrapper .calendar-event-repeat-row .calendar-event-field-location { flex: 1 1 100%; width: 100%; max-width: 100%; }
    .calendar-new-event-wrapper .calendar-event-repeat-row .calendar-event-field-repeat { flex: 1 1 100%; width: 100%; min-width: 0; }
    .calendar-new-event-wrapper .calendar-event-repeat-row:has(#cal-repeat-custom-wrap[style*="display: flex"]) .calendar-event-field-repeat { flex: 0 0 8rem; width: 8rem; max-width: 8rem; min-width: 0; }
    .calendar-new-event-wrapper .calendar-event-repeat-row #cal-repeat-custom-wrap { flex: 1 1 0; min-width: 0; flex-direction: column; align-items: flex-start; gap: 0 0.5rem; }
    .calendar-new-event-wrapper .calendar-event-repeat-row #cal-repeat-custom-wrap label { margin: 0; font-weight: 600; line-height: 1.25; }
    .calendar-new-event-wrapper .calendar-event-repeat-row .cal-repeat-custom-inner { margin-top: 0.25rem; }
    .calendar-new-event-wrapper .calendar-event-repeat-row .cal-repeat-custom-inner input,
    .calendar-new-event-wrapper .calendar-event-repeat-row .cal-repeat-custom-inner select { height: 2.5rem; min-height: 2.5rem; max-height: 2.5rem; box-sizing: border-box; }
    .password-wrapper h1 { font-size: 1.2rem; margin-bottom: 0.5rem; }
    .notes-layout { display: flex; gap: 1rem; min-height: 360px; margin-top: 1rem; }
    @media (max-width: 560px) { .notes-layout { flex-direction: column; } }
    .notes-sidebar { flex: 0 0 220px; min-width: 0; display: flex; flex-direction: column; gap: 0.5rem; border-right: 1px solid var(--border); padding-right: 1rem; }
    @media (max-width: 560px) { .notes-sidebar { border-right: none; border-bottom: 1px solid var(--border); padding-right: 0; padding-bottom: 1rem; flex: 0 0 auto; } }
    .notes-list { list-style: none; margin: 0; padding: 0; flex: 1; min-height: 0; overflow: auto; }
    .notes-list-item { display: block; width: 100%; text-align: left; padding: 0.5rem 0.6rem; margin: 0.2rem 0; border: none; border-radius: 6px; background: transparent; color: var(--text); font-size: 0.9rem; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; border-left: 3px solid transparent; }
    .notes-list-item:hover { background: var(--wax); }
    .notes-list-item.active { background: var(--wax); border-left-color: var(--honey-dark); font-weight: 600; }
    .notes-list-item .notes-list-item-title { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .notes-list-item .notes-list-item-preview { display: block; font-size: 0.75rem; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 0.15rem; }
    .notes-editor { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 0.5rem; }
    .notes-title-input { width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; font-weight: 600; background: var(--card); color: var(--text); box-sizing: border-box; }
    .notes-body-input { flex: 1; min-height: 200px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; resize: vertical; background: var(--card); color: var(--text); box-sizing: border-box; font-family: inherit; }
    .notes-editor-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .notes-editor-actions .btn { width: auto; margin: 0; }
    .app-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem 0.75rem; margin: 1.25rem 0; padding: 0 0.25rem; }
    @media (min-width: 400px) { .app-grid { grid-template-columns: repeat(4, 1fr); gap: 1.5rem 1rem; } }
    @media (min-width: 520px) { .app-grid { gap: 2rem 1.25rem; } }
    .app-card { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.12s ease; border: none; background: none; padding: 0; }
    .app-card:hover { transform: scale(1.04); }
    .app-card:active { transform: scale(0.98); }
    .app-icon-wrap { width: 78px; height: 78px; border-radius: 17px; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    @media (min-width: 520px) { .app-icon-wrap { width: 88px; height: 88px; border-radius: 20px; } }
    .app-card:hover .app-icon-wrap { background: var(--wax); border-color: var(--honey-dark); }
    .app-card .app-icon { font-size: 2.15rem; line-height: 1; }
    @media (min-width: 520px) { .app-card .app-icon { font-size: 2.5rem; } }
    .app-card .app-title { margin-top: 0.5rem; font-weight: 500; font-size: 0.75rem; color: var(--text); text-align: center; line-height: 1.2; max-width: 100%; word-break: break-word; }
    .app-sheet { display: none; min-width: 0; overflow-x: hidden; }
    .app-sheet.active { display: block; }
    .app-sheet .app-sheet-back { margin-bottom: 1rem; }
    .app-sheet .app-sheet-back.btn { width: auto; }
    .app-sheet-header { display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; margin-bottom: 1rem; gap: 0.5rem; }
    .app-sheet-header .app-sheet-back { justify-self: start; margin-bottom: 0; }
    .app-sheet-header h2 { justify-self: center; text-align: center; margin: 0; font-size: 1.2rem; color: var(--honey-dark); }
    .app-sheet-header #calendar-add-event, .app-sheet-header #tasks-add-btn, .app-sheet-header #notes-new-btn { justify-self: end; }
    .app-sheet h2 { font-size: 1.2rem; color: var(--honey-dark); margin: 0 0 0.5rem 0; }
    .app-sheet .app-desc { font-size: 0.9rem; color: var(--muted); margin-bottom: 1rem; }
    .app-sheet .app-desc-full { font-size: 0.9rem; color: var(--muted); margin-bottom: 1rem; }
    .app-sheet .app-desc-full p { margin: 0 0 0.6rem 0; line-height: 1.45; }
    .app-sheet .app-desc-full p:last-child { margin-bottom: 0; }
    .app-sheet .app-desc-full h3 { font-size: 0.95rem; color: var(--honey-dark); margin: 1rem 0 0.4rem 0; }
    .app-sheet .app-desc-full ul { margin: 0 0 0.6rem 0; padding-left: 1.25rem; line-height: 1.45; }
    .app-sheet .app-desc-full pre { font-size: 0.8rem; overflow-x: auto; background: var(--wax); padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0; border: 1px solid var(--border); }
    .app-sheet .app-placeholder-warning { background: #fef3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.9rem; color: #856404; }
    .app-sheet .app-placeholder { background: var(--wax); border: 1px dashed var(--border); border-radius: 8px; padding: 1.5rem; text-align: center; color: var(--muted); }
    .calendar-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
    .calendar-view-switcher { display: flex; gap: 0.25rem; }
    .calendar-view-switcher button { padding: 0.4rem 0.75rem; font-size: 0.85rem; border-radius: 6px; border: 1px solid var(--border); background: var(--card); color: var(--muted); font-weight: 600; cursor: pointer; }
    .calendar-view-switcher button.active { background: var(--honey-dark); color: #fff; border-color: var(--honey-dark); }
    .calendar-nav { display: flex; align-items: center; gap: 0.5rem; margin-left: auto; }
    .calendar-nav button { padding: 0.35rem 0.6rem; min-height: auto; width: auto; font-size: 1rem; }
    .calendar-nav .calendar-label { font-weight: 600; color: var(--honey-dark); min-width: 140px; text-align: center; font-size: 0.95rem; display: inline-block; }
    @media (max-width: 767px) {
      .calendar-toolbar { flex-direction: column; align-items: stretch; width: 100%; }
      .calendar-view-switcher { width: 100%; }
      .calendar-view-switcher button { flex: 1; }
      .calendar-nav { width: 100%; margin-left: 0; }
      .calendar-nav .calendar-label { flex: 1; min-width: 0; max-width: 215px; min-width: 215px !important; }
      .calendar-nav button { flex-shrink: 0; padding: 0.5rem 0.85rem; min-width: 2.75rem; }
    }
    :root { --cal-cell-height: 95px; --cal-header-height: 2rem; --cal-five-rows-height: calc(var(--cal-header-height) + 5 * var(--cal-cell-height)); }
    .calendar-month { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; min-height: var(--cal-five-rows-height); }
    .calendar-month .cal-weekday { padding: 0.35rem; text-align: center; font-size: 0.7rem; font-weight: 600; color: var(--muted); background: var(--wax); }
    .calendar-month .cal-day { min-height: var(--cal-cell-height); padding: 0.35rem; background: var(--card); font-size: 0.8rem; }
    .calendar-month .cal-day.other-month { background: var(--bg); color: var(--muted); }
    .calendar-month .cal-day.today { background: var(--wax); border: 1px solid var(--honey-dark); }
    .calendar-month .cal-day-num { font-weight: 600; margin-bottom: 0.25rem; }
    .calendar-month .cal-day-events { font-size: 0.7rem; }
    .calendar-month .cal-event-dot { display: inline-block; margin-right: 0.2rem; padding: 0 0.25rem; border-radius: 4px; background: var(--honey-dark); color: #fff; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
    .calendar-week { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; height: var(--cal-five-rows-height); }
    .calendar-week .cal-day-col { min-height: 0; padding: 0; background: var(--card); display: flex; flex-direction: column; }
    .calendar-week .cal-day-col.other-month { background: var(--bg); color: var(--muted); }
    .calendar-week .cal-day-col.today .cal-day-events { background: var(--wax); border: 1px solid var(--honey-dark); }
    .calendar-week .cal-day-header { padding: 0.35rem; text-align: center; font-size: 0.7rem; font-weight: 600; color: var(--muted); background: var(--wax); flex-shrink: 0; }
    .calendar-week .cal-day-events { flex: 1; min-height: 0; padding: 0.35rem 0.35rem 0 0.35rem; font-size: 0.7rem; overflow: auto; border-radius: 0 0 6px 6px; }
    .calendar-week .cal-day-events .cal-event-dot { display: block; margin-bottom: 0.2rem; }
    .calendar-day-wrap { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 0.35rem; }
    .calendar-day-list { padding: 0; }
    .calendar-day .cal-day-header { font-size: 1.1rem; font-weight: 600; color: var(--honey-dark); margin-bottom: 0.75rem; }
    .calendar-day .cal-event-item { padding: 0.6rem; margin-bottom: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; }
    .calendar-day .cal-event-item:hover { background: var(--wax); border-color: var(--honey-dark); }
    .calendar-day .cal-event-time { font-size: 0.8rem; color: var(--muted); margin-right: 0.5rem; }
    .calendar-event-form { background: var(--wax); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; overflow: hidden; min-width: 0; }
    .calendar-event-form label { display: block; font-weight: 600; margin-top: 0.5rem; }
    .calendar-event-form input, .calendar-event-form select, .calendar-event-form textarea { width: 100%; max-width: 100%; min-width: 0; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin: 0.25rem 0; box-sizing: border-box; background: var(--card); color: var(--text); }
    .calendar-event-form input[type="text"], .calendar-event-form input[type="time"], .calendar-event-form input[type="date"], .calendar-event-form select { height: 2.5rem; min-height: 2.5rem; max-height: 2.5rem; line-height: 1.25; }
    .calendar-event-form input[type="date"] { background: var(--card) !important; color: var(--text) !important; font-size: 1rem; }
    .calendar-event-form textarea { min-height: 60px; resize: vertical; background: var(--card); color: var(--text); }
    .calendar-event-form .form-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
    .calendar-event-form .form-actions .btn { width: auto; }
    .calendar-event-form-row { display: flex; flex-wrap: wrap; align-items: flex-start; gap: 0.5rem 1rem; margin-bottom: 0.5rem; }
    .calendar-event-form-row .calendar-event-field { flex: 1 1 8rem; min-width: 0; display: flex; flex-direction: column; align-items: flex-start; }
    .calendar-event-form-row .calendar-event-field label { margin-top: 0; line-height: 1.25; }
    .calendar-event-title-row .calendar-event-field { flex: 1 1 100%; min-width: 0; }
    .calendar-event-repeat-row .calendar-event-field-location { flex: 0 1 15rem; min-width: 0; max-width: 15rem; }
    .calendar-event-repeat-row .calendar-event-field-repeat { flex: 1 1 0; min-width: 7rem; }
    .calendar-event-repeat-row #cal-repeat-custom-wrap { flex: 1 1 0; min-width: 8rem; flex-direction: column; align-items: flex-start; gap: 0.25rem; }
    .cal-repeat-custom-inner { display: flex; flex-wrap: nowrap; align-items: center; gap: 0.5rem; width: 100%; }
    .cal-repeat-custom-inner input[type="number"] { width: 4rem; flex: 0 0 auto; }
    .cal-repeat-custom-inner select { flex: 1 1 0; min-width: 0; }
    .cal-repeat-custom-inner input, .cal-repeat-custom-inner select { height: 2.5rem; min-height: 2.5rem; max-height: 2.5rem; line-height: 1.25; box-sizing: border-box; }
    #cal-repeat-custom-wrap { display: none; flex-direction: column; align-items: flex-start; gap: 0.25rem; }
    #cal-repeat-custom-wrap label { margin-top: 0; width: auto; }
    #cal-repeat-custom-wrap input, #cal-repeat-custom-wrap select { padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; line-height: 1.25; margin: 0; box-sizing: border-box; background: var(--card); color: var(--text); }
    #cal-repeat-custom-wrap input[type="number"] { width: 4rem; }
    #cal-repeat-custom-wrap select { width: auto; min-width: 7rem; }
    .cal-event-item .cal-event-location { font-size: 0.85rem; color: var(--muted); margin-left: 0.25rem; }
    .home-layout { display: flex; flex-direction: row; gap: 1rem; width: 100%; min-height: 0; }
    .home-main { flex: 1; min-width: 0; display: flex; flex-direction: column; }
    @media (max-width: 767px) {
      .home-layout { flex-direction: column; align-items: stretch; }
      .home-main { width: 100%; min-width: 0; box-sizing: border-box; }
    }
    @media (min-width: 768px) and (hover: none) and (pointer: coarse) {
      #sheet-home .app-grid { gap: 2.75rem 1.75rem; }
      .app-icon-wrap { width: 132px; height: 132px; border-radius: 30px; }
      .app-card .app-icon { font-size: 4.1rem; }
      .app-card .app-title { font-size: 1rem; margin-top: 0.75rem; }
      .home-header-bar { width: 250px; max-height: none; height: auto; }
      }
    .home-header-bar { flex: 0 0 auto; width: 200px; min-height: 3rem; max-height: 80vh; overflow-y: auto; background: var(--honey-dark); color: #fff; border-radius: 10px; padding: 0.75rem 1rem; margin-bottom: 0; box-sizing: border-box; display: flex; flex-direction: column; gap: 1rem; }
    @media (max-width: 767px) {
      .home-header-bar { flex: 0 0 auto; width: calc(100% + 2rem); max-width: none; margin-left: -1rem; margin-right: -1rem; max-height: none; height: auto; box-sizing: border-box; order: -1; padding: 1rem 2rem; }
    }
    .home-header-bar.empty { display: none; }
    .home-layout:has(.app-sheet.active) .home-header-bar { display: none; }
    .home-header-col { flex: 0 0 auto; min-width: 0; width: 100%; }
    .home-header-col .home-col-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.9; margin-bottom: 0.4rem; text-align: center; }
    .home-header-bar .home-today-empty, .home-header-bar .home-upcoming-empty { display: flex; align-items: center; justify-content: center; min-height: 2.5rem; font-size: 0.9rem; color: rgba(255,255,255,0.9); }
    .home-header-bar .home-today-events, .home-header-bar .home-upcoming-events { list-style: none; padding: 0; margin: 0; width: 100%; }
    .home-header-bar .home-today-event, .home-header-bar .home-upcoming-event { padding: 0.35rem 0; border-bottom: 1px solid rgba(255,255,255,0.25); font-size: 0.85rem; display: block; width: 100%; box-sizing: border-box; }
    .home-header-bar .home-event-pill, .home-header-bar .home-task-pill { cursor: pointer; }
    .home-header-bar .home-today-event:last-child, .home-header-bar .home-upcoming-event:last-child { border-bottom: none; }
    .home-header-bar .home-event-day { display: block; font-size: 0.7rem; opacity: 0.85; margin-bottom: 0.15rem; }
    .home-event-pill { display: block; width: 100%; box-sizing: border-box; border: 1px solid rgba(255,255,255,0.55); border-radius: 6px; padding: 0.35rem 0.5rem; font-size: 0.85rem; background: rgba(255,255,255,0.55); color: #2c2416; text-align: center; }
    .home-task-pill { display: block; width: 100%; box-sizing: border-box; border: 1px solid; border-radius: 6px; padding: 0.35rem 0.5rem; font-size: 0.85rem; font-weight: 500; text-align: center; }
    .home-task-pill.priority-low { border-color: #2d6a2d; background: rgba(45,106,45,0.5); color: #fff; }
    .home-task-pill.priority-medium { border-color: #c9a800; background: rgba(201,168,0,0.5); color: #fff; }
    .home-task-pill.priority-high { border-color: #a52a2a; background: rgba(165,42,42,0.55); color: #fff; }
    .home-header-bar .home-event-time { font-size: 0.75rem; opacity: 0.9; min-width: 3.5rem; }
    .home-header-bar .home-event-title { flex: 1; }
    .tasks-view-toggle { display: flex; gap: 0.25rem; margin-bottom: 1rem; }
    .tasks-view-toggle button { flex: 1; padding: 0.5rem; font-size: 0.9rem; font-weight: 600; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--muted); cursor: pointer; }
    .tasks-view-toggle button.active { background: var(--honey-dark); color: #fff; border-color: var(--honey-dark); }
    .tasks-form-wrap { background: var(--wax); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; overflow: hidden; min-width: 0; }
    .tasks-form-wrap label { display: block; font-weight: 600; margin-top: 0.5rem; }
    .tasks-form-wrap input, .tasks-form-wrap select { width: 100%; max-width: 100%; min-width: 0; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin: 0.25rem 0; box-sizing: border-box; background: var(--card); color: var(--text); }
    .tasks-form-wrap input[type="text"],
    .tasks-form-wrap input[type="date"],
    .tasks-form-wrap select { height: 2.5rem; min-height: 2.5rem; max-height: 2.5rem; line-height: 1.25; }
    .tasks-form-wrap input[type="date"] { background: var(--card) !important; color: var(--text) !important; font-size: 1rem; }
    .tasks-form-wrap .form-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
    .tasks-form-wrap .form-actions .btn { width: auto; }
    #task-cancel, #cal-event-cancel { background: #fff; color: var(--honey-dark); border: 1px solid var(--honey-dark); }
    .tasks-name-priority-row { display: flex; flex-wrap: wrap; align-items: flex-start; gap: 0.5rem 1rem; margin-bottom: 0.5rem; }
    .tasks-name-priority-row .tasks-field { min-width: 0; display: flex; flex-direction: column; align-items: flex-start; }
    .tasks-name-priority-row .tasks-field label { margin-top: 0; line-height: 1.25; }
    .tasks-field-name { flex: 1 1 12rem; min-width: 0; }
    .tasks-field-priority { flex: 0 0 auto; min-width: 8rem; }
    .tasks-date-row { display: flex; align-items: flex-start; margin-top: 0.5rem; padding-right: 1rem; }
    .tasks-date-row .tasks-field { min-width: 0; display: flex; flex-direction: column; align-items: flex-start; }
    .tasks-date-row .tasks-field label { margin-top: 0; line-height: 1.25; }
    .tasks-date-row .tasks-field-date { flex: 1 1 100%; width: 100%; max-width: 100%; }
    .tasks-repeat-row { display: flex; flex-wrap: wrap; align-items: flex-end; gap: 0.5rem 1rem; margin-top: 0.5rem; }
    .tasks-repeat-row .tasks-field { min-width: 0; display: flex; flex-direction: column; align-items: flex-start; }
    .tasks-repeat-row .tasks-field label { margin-top: 0; line-height: 1.25; }
    .tasks-field-date { flex: 0 0 auto; width: 10rem; max-width: 10rem; }
    .tasks-field-date input[type="date"] { width: 100%; max-width: 100%; min-width: 0; }
    .tasks-field-repeat { flex: 0 0 auto; min-width: 10rem; }
    #tasks-repeat-custom-wrap { flex: 0 0 auto; display: none; flex-direction: row; align-items: flex-end; gap: 0.5rem; }
    /* iPad / touch only: same 2rem height for date and 3.25rem for other task form controls */
    @media (hover: none) and (pointer: coarse) {
      .tasks-new-task-wrapper .tasks-date-row .tasks-field-date { margin-right: 1rem; }
      .tasks-field-date { width: 9rem; max-width: 9rem; }
      .tasks-form-wrap #task-title,
      .tasks-form-wrap #task-priority,
      .tasks-form-wrap #task-repeat { height: 3.25rem !important; min-height: 3.25rem !important; max-height: 3.25rem !important; }
      .tasks-new-task-wrapper .tasks-repeat-custom-inner input,
      .tasks-new-task-wrapper .tasks-repeat-custom-inner select { height: 3.25rem !important; min-height: 3.25rem !important; max-height: 3.25rem !important; box-sizing: border-box; }
      .tasks-date-row #task-date { height: 2rem !important; min-height: 2rem !important; max-height: 2rem !important; }
      .tasks-field-date input[type="date"] { width: 100% !important; max-width: 100% !important; min-width: 0 !important; }
      /* Calendar add event: same iPad treatment */
      .calendar-event-form #cal-event-title,
      .calendar-event-form #cal-event-location,
      .calendar-event-form #cal-event-repeat { height: 3.25rem !important; min-height: 3.25rem !important; max-height: 3.25rem !important; }
      .calendar-event-form #cal-event-date,
      .calendar-event-form #cal-event-end-date,
      .calendar-event-form #cal-event-time,
      .calendar-event-form #cal-event-end-time { height: 2rem !important; min-height: 2rem !important; max-height: 2rem !important; }
      .calendar-event-form-row:nth-child(2) .calendar-event-field,
      .calendar-event-form-row:nth-child(3) .calendar-event-field { flex: 1 1 0; min-width: 0; }
      .calendar-event-form-row:nth-child(2) .calendar-event-field:first-child,
      .calendar-event-form-row:nth-child(3) .calendar-event-field:first-child { margin-right: 1rem; }
      .calendar-event-form-row:nth-child(2) .calendar-event-field:nth-child(2),
      .calendar-event-form-row:nth-child(3) .calendar-event-field:nth-child(2) { margin-right: 1rem; }
      .calendar-event-form #cal-event-date,
      .calendar-event-form #cal-event-end-date,
      .calendar-event-form #cal-event-time,
      .calendar-event-form #cal-event-end-time { width: 100% !important; max-width: 100% !important; min-width: 0 !important; }
      .calendar-event-form .cal-repeat-custom-inner input,
      .calendar-event-form .cal-repeat-custom-inner select { height: 3.25rem !important; min-height: 3.25rem !important; max-height: 3.25rem !important; line-height: 1.25; box-sizing: border-box; }
      .calendar-event-form-row { gap: 0.5rem 1rem; }
    }
    .tasks-field-repeat { flex: 1 1 8rem; min-width: 8rem; }
    .tasks-field-custom { flex: 2 1 0; min-width: 10rem; flex-direction: column; align-items: flex-start; }
    .tasks-repeat-custom-inner { display: flex; flex-wrap: nowrap; align-items: center; gap: 0.5rem; width: 100%; }
    .tasks-repeat-custom-inner input[type="number"] { flex: 0 0 auto; width: 4rem; }
    .tasks-repeat-custom-inner select { flex: 1 1 0; min-width: 0; }
    .tasks-repeat-custom-inner input, .tasks-repeat-custom-inner select { height: 2.5rem; min-height: 2.5rem; max-height: 2.5rem; box-sizing: border-box; }
    #tasks-repeat-custom-wrap label { margin-top: 0; margin-bottom: 0; width: auto; }
    .tasks-repeat-row #tasks-repeat-custom-wrap { gap: 0.25rem 0.5rem; }
    #tasks-repeat-custom-wrap input, #tasks-repeat-custom-wrap select { padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin: 0; box-sizing: border-box; background: var(--card); color: var(--text); }
    #tasks-repeat-custom-wrap input[type="number"] { width: 4rem; }
    #tasks-repeat-custom-wrap select { width: auto; min-width: 7rem; }
    .tasks-group { margin-bottom: 1.25rem; }
    .tasks-group-title { font-size: 0.8rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.5rem; padding-bottom: 0.25rem; }
    .tasks-list { list-style: none; padding: 0; margin: 0; }
    .tasks-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.5rem; border-bottom: 1px solid var(--border); background: var(--card); border-radius: 6px; margin-bottom: 0.35rem; }
    .tasks-item .task-priority { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .tasks-item .task-priority.low { background: #2d6a2d; }
    .tasks-item .task-priority.medium { background: #c9a800; }
    .tasks-item .task-priority.high { background: #a52a2a; }
    .tasks-item .task-checkbox { flex-shrink: 0; cursor: pointer; }
    .tasks-item .task-content { flex: 1; min-width: 0; font-size: 0.95rem; }
    .tasks-item .task-time { font-size: 0.8rem; color: var(--muted); margin-right: 0.5rem; }
    .tasks-item .task-actions { flex-shrink: 0; }
    .tasks-item.completed .task-content { text-decoration: line-through; color: var(--muted); }
    .tasks-item .task-completed-at { font-size: 0.8rem; color: var(--muted); margin-left: 0.35rem; font-weight: normal; }
  </style>
</head>
<body>
  <!-- Unlock gate (when encryption is on). Default active so app is not visible before init. -->
  <div id="screen-gate" class="screen active">
    <div class="card">
      <h1>HoneyApp</h1>
      <p class="help" id="gate_help">Enter admin username and password to unlock.</p>
      <form id="unlock_form" autocomplete="off">
        <label for="unlock_username">Username</label>
        <input type="text" id="unlock_username" placeholder="Username" autocomplete="username">
        <label for="unlock_password">Password</label>
        <input type="password" id="unlock_password" placeholder="Password" autocomplete="current-password">
        <label class="help" style="display:flex;align-items:center;gap:0.5rem;margin:0.5rem 0 0 0;cursor:pointer;">
          <input type="checkbox" id="unlock_keep_session" name="keep_session" autocomplete="off">
          <span>Keep unlocked for this session (until you close the tab)</span>
        </label>
        <button type="submit" id="btn_unlock" class="btn">Unlock</button>
      </form>
      <p id="gate_status" class="status err" aria-live="polite"></p>
    </div>
  </div>

  <!-- Token gate: require valid GitHub token on this device before using the app -->
  <div id="screen-token-gate" class="screen">
    <div class="card">
      <h1>GitHub token required</h1>
      <p class="help" id="token_gate_help">This device does not have a valid GitHub token. Enter your personal access token to continue. It is stored on this device only.</p>
      <form id="token_gate_form" autocomplete="off">
        <label for="token_gate_input">Personal access token</label>
        <input type="password" id="token_gate_input" placeholder="ghp_... or token" autocomplete="off">
        <button type="submit" id="btn_token_continue" class="btn">Continue</button>
      </form>
      <p id="token_gate_status" class="status" aria-live="polite"></p>
    </div>
  </div>

  <div id="screen-app" class="screen">
    <div class="home-layout">
      <aside id="home-header" class="home-header-bar"></aside>
      <div class="home-main">
        <div id="sheet-home" class="sheet active">
      <div id="home-app-grid" class="app-grid">
        <div class="app-card" data-app="database" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">üì¶</span></div><div class="app-title">Database</div></div>
        <div class="app-card" data-app="projects" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">üìã</span></div><div class="app-title">Projects</div></div>
        <div class="app-card" data-app="inventory" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">üìä</span></div><div class="app-title">Inventory</div></div>
        <div class="app-card" data-app="graphs" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">üìà</span></div><div class="app-title">Graphs</div></div>
        <div class="app-card" data-app="predictions" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">üéØ</span></div><div class="app-title">Predictions</div></div>
        <div class="app-card" data-app="cost-calculator" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">üßÆ</span></div><div class="app-title">Cost calculator</div></div>
        <div class="app-card" data-app="orders" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">üõí</span></div><div class="app-title">Sales log</div></div>
        <div class="app-card" data-app="suppliers" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">üè≠</span></div><div class="app-title">Suppliers</div></div>
        <div class="app-card" data-app="tasks" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">‚úÖ</span></div><div class="app-title">Tasks</div></div>
        <div class="app-card" data-app="notes" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">üìù</span></div><div class="app-title">Notes</div></div>
        <div class="app-card" data-app="calendar" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">üìÖ</span></div><div class="app-title">Calendar</div></div>
        <div class="app-card" data-app="settings" role="button" tabindex="0"><div class="app-icon-wrap"><span class="app-icon">‚öôÔ∏è</span></div><div class="app-title">Settings</div></div>
      </div>
      <div id="app-sheet-database" class="app-sheet" data-app="database">
        <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
        <h2>üì¶ Database</h2>
        <div class="app-desc-full">
          <p>Stores <strong>prices</strong> for everything you buy or sell: equipment, supplies, and finished products. Each entry has a name, category (e.g. equipment / supplies / product), price, and optional notes. This is the single source of truth for unit costs so Cost calculator, Inventory, and Sales log can reference it.</p>
          <p><strong>Features to build:</strong> Add, edit, delete entries; list and filter by category.</p>
          <h3>üóÑÔ∏è 1. Database (The Master Reference)</h3>
          <p>This is the "Source of Truth." No other app should have hard-coded prices.</p>
          <ul>
            <li><strong>Item Name:</strong> (e.g., "500g Hexagonal Jar", "Wildflower Honey Bulk").</li>
            <li><strong>SKU/ID:</strong> Unique identifier for linking.</li>
            <li><strong>Category:</strong> Raw Material, Packaging, Finished Good, Equipment.</li>
            <li><strong>Unit of Measure:</strong> kg, gram, unit, box.</li>
            <li><strong>Unit Cost:</strong> Your purchase price from suppliers.</li>
            <li><strong>Target Sale Price:</strong> The intended MSRP.</li>
            <li><strong>Tax Rate:</strong> If applicable (e.g., 0% for raw food, 10% for beeswax candles).</li>
          </ul>
          <h3>üõ†Ô∏è Data Relationship Map</h3>
          <p>To keep your Encrypted Config clean, use a flat JSON structure where each app is its own key:</p>
          <pre>{
  "database": [ { "id": "jar-001", "price": 0.50, ... } ],
  "inventory": [ { "item_id": "jar-001", "qty": 500 } ],
  "sales_log": [ { "id": "sale-101", "total": 25.00, ... } ],
  "settings": { "github_token": "...", "version": "1.0.0" }
}</pre>
        </div>
        <div class="app-placeholder">Placeholder ‚Äî build this app next.</div>
      </div>
      <div id="app-sheet-projects" class="app-sheet" data-app="projects">
        <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
        <h2>üìã Projects</h2>
        <div class="app-desc-full">
          <p>Manages <strong>multi-step initiatives</strong> and their timelines. Each project has a name, optional due date, status (e.g. planning / in progress / done), and can have phases or milestones. For planning and tracking bigger efforts, not day-to-day tasks.</p>
          <p><strong>Features to build:</strong> Create projects, set due dates, update status; optional list of phases or milestones.</p>
          <h3>üèóÔ∏è 8. Projects (Long-term Strategy)</h3>
          <p>Unlike Tasks, these are "Parent" containers.</p>
          <ul>
            <li><strong>Project Goal:</strong> (e.g., "Expansion to 50 Hives" or "Organic Certification").</li>
            <li><strong>Status:</strong> Backlog, Active, Blocked, Complete.</li>
            <li><strong>Milestones:</strong> High-level checkboxes (e.g., "Apply for permit", "Buy Nucs").</li>
            <li><strong>Linked Tasks:</strong> Pulls in items from your Tasks app that share a Project ID.</li>
          </ul>
        </div>
        <div class="app-placeholder">Placeholder ‚Äî build this app next.</div>
      </div>
      <div id="app-sheet-inventory" class="app-sheet" data-app="inventory">
        <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
        <h2>üìä Inventory</h2>
        <div class="app-desc-full">
          <p>Tracks <strong>stock levels</strong>: what you've made or bought (in) and what you've sold or used (out). Each item links to a product or supply (ideally from Database). Records quantity on hand and optional movements (add/remove with reason and date).</p>
          <p><strong>Features to build:</strong> List items with quantities; log in/out movements; simple current-stock view.</p>
          <h3>üì¶ 3. Inventory (Stock &amp; Flow)</h3>
          <p>This app calculates the "Current Balance" by looking at In vs. Out.</p>
          <ul>
            <li><strong>Current Stock:</strong> Real-time quantity.</li>
            <li><strong>Reorder Point:</strong> A threshold that triggers a "Task" to buy more.</li>
            <li><strong>Location:</strong> (e.g., "Warehouse Shelf A", "Garage Hive Yard").</li>
            <li><strong>Movement Log:</strong> Date, Quantity, Type (Restock, Sale, Damage, Harvest), Batch ID.</li>
          </ul>
        </div>
        <div class="app-placeholder">Placeholder ‚Äî build this app next.</div>
      </div>
      <div id="app-sheet-graphs" class="app-sheet" data-app="graphs">
        <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
        <h2>üìà Graphs</h2>
        <div class="app-desc-full">
          <p>Visualizes <strong>data from the app</strong>, especially sales (from Sales log) and optionally inventory or costs. E.g. sales over time, by product, or simple comparisons. Read-only‚Äîno new data entry; charts are driven by existing data.</p>
          <p><strong>Features to build:</strong> One or more charts (e.g. line/bar) driven by Sales log and later other sources.</p>
          <h3>üìà 6. Graphs (Visual Intelligence)</h3>
          <p>This is a read-only dashboard pulling from the Sales Log.</p>
          <ul>
            <li><strong>Revenue vs. Time:</strong> Line chart (Monthly/Weekly).</li>
            <li><strong>Product Mix:</strong> Pie chart (Which honey flavor sells best?).</li>
            <li><strong>Channel Performance:</strong> Bar chart (Market vs. Online).</li>
            <li><strong>Burn Rate:</strong> How fast you are using jars/lids vs. your sales.</li>
          </ul>
        </div>
        <div class="app-placeholder">Placeholder ‚Äî build this app next.</div>
      </div>
      <div id="app-sheet-predictions" class="app-sheet" data-app="predictions">
        <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
        <h2>üéØ Predictions</h2>
        <div class="app-desc-full">
          <p>Lets you set <strong>targets</strong> (e.g. revenue, units sold, profit) and see <strong>what's needed</strong> to get there (e.g. units to sell, price or cost assumptions). Uses data from Sales log, Database, and optionally Inventory.</p>
          <p><strong>Features to build:</strong> Set target and timeframe; show gap vs current trend and simple "required per day/unit" metrics.</p>
          <h3>üéØ 7. Predictions (The "Crystal Ball")</h3>
          <ul>
            <li><strong>Sales Forecasting:</strong> Uses last year's data + a "Growth %" modifier.</li>
            <li><strong>Stock-Out Dates:</strong> "Based on current sales, you will run out of jars in 14 days."</li>
            <li><strong>Harvest Goals:</strong> "To hit $50k revenue, you need to harvest X amount of honey this season."</li>
          </ul>
        </div>
        <div class="app-placeholder">Placeholder ‚Äî build this app next.</div>
      </div>
      <div id="app-sheet-cost-calculator" class="app-sheet" data-app="cost-calculator">
        <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
        <h2>üßÆ Cost calculator</h2>
        <div class="app-placeholder-warning"><strong>‚ö†Ô∏è Build order:</strong> Database and Inventory apps should be built before Cost Calculator so it can reference prices and items.</div>
        <div class="app-desc-full">
          <p>Uses <strong>Database</strong> prices to compute the cost of a recipe or batch: pick items and quantities, app sums total cost (and optional unit cost per output). No new price storage‚Äîonly reads from Database.</p>
          <p><strong>Features to build:</strong> Select items and quantities; show total and optional per-unit cost.</p>
          <h3>üßÆ 4. Cost Calculator (The Recipe Book)</h3>
          <p>This app doesn't store prices; it performs math on Database items.</p>
          <ul>
            <li><strong>Product Template:</strong> (e.g., "Lavender Infused Honey - Small").</li>
            <li><strong>Bill of Materials (BOM):</strong> Item ID + Quantity used (e.g., 1 Jar + 250g Honey + 1 Lid + 1 Label).</li>
            <li><strong>Overhead Markup:</strong> A percentage (e.g., 20%) to cover electricity/rent.</li>
            <li><strong>Calculated Field:</strong> Total Cost to Produce vs. Profit Margin %.</li>
          </ul>
        </div>
        <div class="app-placeholder">Placeholder ‚Äî build this app next.</div>
      </div>
      <div id="app-sheet-orders" class="app-sheet" data-app="orders">
        <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
        <h2>üõí Sales log</h2>
        <div class="app-placeholder-warning"><strong>‚ö†Ô∏è Build order:</strong> Database and Inventory apps should be built before Sales Log so it can reference products and optionally deduct from stock.</div>
        <div class="app-desc-full">
          <p>Logs <strong>individual sales</strong>: who, when, what product(s), quantity, price/revenue, optional customer or note. This is the transaction log that Graphs and Predictions use; Inventory may deduct from stock when you record a sale.</p>
          <p><strong>Features to build:</strong> Add/edit sales with date, items, quantities, amounts; list and filter by date or product.</p>
          <h3>üõí 5. Sales Log (Orders)</h3>
          <p>The engine for your Graphs and Predictions.</p>
          <ul>
            <li><strong>Transaction ID:</strong> Unique order number.</li>
            <li><strong>Customer Info:</strong> Name/Email (for CRM marketing).</li>
            <li><strong>Channel:</strong> Farmers Market, Website, Wholesale, Farm Gate.</li>
            <li><strong>Line Items:</strong> Product ID + Quantity + Price Sold.</li>
            <li><strong>Inventory Toggle:</strong> A checkbox: "Deduct from Inventory?" (Auto-updates App #3).</li>
          </ul>
        </div>
        <div class="app-placeholder">Placeholder ‚Äî build this app next.</div>
      </div>
      <div id="app-sheet-suppliers" class="app-sheet" data-app="suppliers">
        <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
        <h2>üè≠ Suppliers</h2>
        <div class="app-desc-full">
          <p>Stores <strong>supplier info</strong>: name, contact (phone/email), optional address, notes, and which items (from Database or Inventory) they supply. For finding who to reorder from; prices stay in Database.</p>
          <p><strong>Features to build:</strong> Add, edit, delete suppliers; link to products/supplies; simple list and search.</p>
          <h3>üè≠ 2. Suppliers</h3>
          <ul>
            <li><strong>Company Name &amp; Contact:</strong> Primary contact person.</li>
            <li><strong>Lead Time:</strong> How many days it takes for them to deliver (crucial for "Predictions").</li>
            <li><strong>Minimum Order Quantity (MOQ):</strong> Minimum jars/labels you must buy.</li>
            <li><strong>Linked Items:</strong> A list of IDs from your Database that this supplier provides.</li>
            <li><strong>Reliability Rating:</strong> 1‚Äì5 stars (did they break the jars during shipping?).</li>
          </ul>
        </div>
        <div class="app-placeholder">Placeholder ‚Äî build this app next.</div>
      </div>
      <div id="app-sheet-tasks" class="app-sheet" data-app="tasks">
        <div class="app-sheet-header">
          <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
          <h2>Tasks</h2>
          <button type="button" class="btn secondary" id="tasks-add-btn">Add task</button>
        </div>
        <div class="tasks-view-toggle">
          <button type="button" id="tasks-view-scheduled" class="active">Scheduled</button>
          <button type="button" id="tasks-view-completed">Completed</button>
        </div>
        <div id="tasks-form-placeholder">
          <div id="tasks-form-wrap" class="tasks-form-wrap" style="display: none;">
          <div class="tasks-name-priority-row">
            <div class="tasks-field tasks-field-name">
              <label for="task-title">Name</label>
              <input type="text" id="task-title" placeholder="Task name" autocomplete="off">
            </div>
            <div class="tasks-field tasks-field-priority">
              <label for="task-priority">Priority</label>
              <select id="task-priority">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          <div class="tasks-date-row">
            <div class="tasks-field tasks-field-date">
              <label for="task-date">Date</label>
              <input type="date" id="task-date" autocomplete="off">
            </div>
          </div>
          <div class="tasks-repeat-row">
            <div class="tasks-field tasks-field-repeat">
              <label for="task-repeat">Repeat</label>
              <select id="task-repeat">
                <option value="">None</option>
                <option value="daily">Every day</option>
                <option value="weekly">Every week</option>
                <option value="biweekly">Every 2 weeks</option>
                <option value="monthly">Every month</option>
                <option value="yearly">Every year</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div id="tasks-repeat-custom-wrap" class="tasks-field tasks-field-custom">
              <label for="task-repeat-interval">Every</label>
              <div class="tasks-repeat-custom-inner">
                <input type="number" id="task-repeat-interval" min="1" max="99" value="1" autocomplete="off">
                <select id="task-repeat-frequency">
                  <option value="daily">day(s)</option>
                  <option value="weekly">week(s)</option>
                  <option value="monthly">month(s)</option>
                  <option value="yearly">year(s)</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn" id="task-save">Save</button>
            <button type="button" class="btn secondary" id="task-cancel">Cancel</button>
            <button type="button" class="btn btn-remove" id="task-delete" style="display: none;">Delete</button>
          </div>
        </div>
        </div>
        <div id="tasks-list-container"></div>
      </div>
      <div id="tasks-new-task-wrapper" class="tasks-new-task-wrapper" aria-hidden="true">
        <div class="card">
          <div id="tasks-new-task-content"></div>
        </div>
      </div>
      <div id="calendar-new-event-wrapper" class="calendar-new-event-wrapper" aria-hidden="true">
        <div class="card">
          <div id="calendar-new-event-content"></div>
        </div>
      </div>
      <div id="app-sheet-notes" class="app-sheet" data-app="notes">
        <div class="app-sheet-header">
          <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
          <h2>Notes</h2>
          <button type="button" class="btn secondary" id="notes-new-btn">New note</button>
        </div>
        <div class="notes-layout">
          <aside class="notes-sidebar">
            <ul id="notes-list" class="notes-list" aria-label="Notes"></ul>
          </aside>
          <div class="notes-editor">
            <input type="text" id="notes-title" class="notes-title-input" placeholder="Note title" aria-label="Note title" autocomplete="off">
            <textarea id="notes-body" class="notes-body-input" placeholder="Write your note here‚Ä¶" aria-label="Note body" autocomplete="off"></textarea>
            <div class="notes-editor-actions">
              <button type="button" class="btn" id="notes-save-btn">Save</button>
              <button type="button" class="btn secondary" id="notes-delete-btn">Delete</button>
            </div>
          </div>
        </div>
      </div>
      <div id="app-sheet-calendar" class="app-sheet" data-app="calendar">
        <div class="app-sheet-header">
          <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
          <h2>Calendar</h2>
          <button type="button" class="btn secondary" id="calendar-add-event">Add event</button>
        </div>
        <div class="calendar-toolbar">
          <div class="calendar-view-switcher">
            <button type="button" data-cal-view="month" class="active">Month</button>
            <button type="button" data-cal-view="week">Week</button>
            <button type="button" data-cal-view="day">Day</button>
          </div>
          <div class="calendar-nav">
            <button type="button" class="btn secondary" id="calendar-prev" aria-label="Previous">‚Üê</button>
            <span class="calendar-label" id="calendar-label">February 2026</span>
            <button type="button" class="btn secondary" id="calendar-next" aria-label="Next">‚Üí</button>
          </div>
        </div>
        <div id="calendar-event-form-placeholder">
        <div id="calendar-event-form-wrap" class="calendar-event-form" style="display: none;">
          <div class="calendar-event-form-row calendar-event-title-row">
            <div class="calendar-event-field">
              <label for="cal-event-title">Title</label>
              <input type="text" id="cal-event-title" placeholder="Event title" autocomplete="off">
            </div>
          </div>
          <div class="calendar-event-form-row">
            <div class="calendar-event-field">
              <label for="cal-event-date">Start date</label>
              <input type="date" id="cal-event-date" autocomplete="off">
            </div>
            <div class="calendar-event-field">
              <label for="cal-event-time">Start time</label>
              <input type="time" id="cal-event-time" autocomplete="off">
            </div>
          </div>
          <div class="calendar-event-form-row">
            <div class="calendar-event-field">
              <label for="cal-event-end-date">End date</label>
              <input type="date" id="cal-event-end-date" autocomplete="off">
            </div>
            <div class="calendar-event-field">
              <label for="cal-event-end-time">End time</label>
              <input type="time" id="cal-event-end-time" autocomplete="off">
            </div>
          </div>
          <div class="calendar-event-form-row calendar-event-repeat-row">
            <div class="calendar-event-field calendar-event-field-location">
              <label for="cal-event-location">Location</label>
              <input type="text" id="cal-event-location" placeholder="Where" autocomplete="off">
            </div>
            <div class="calendar-event-field calendar-event-field-repeat">
              <label for="cal-event-repeat">Repeat</label>
              <select id="cal-event-repeat">
                <option value="">None</option>
                <option value="daily">Every day</option>
                <option value="weekly">Every week</option>
                <option value="biweekly">Every 2 weeks</option>
                <option value="monthly">Every month</option>
                <option value="yearly">Every year</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div id="cal-repeat-custom-wrap" class="calendar-event-field">
              <label for="cal-repeat-interval">Every</label>
              <div class="cal-repeat-custom-inner">
                <input type="number" id="cal-repeat-interval" min="1" max="99" value="1">
                <select id="cal-repeat-frequency">
                  <option value="daily">day(s)</option>
                  <option value="weekly">week(s)</option>
                  <option value="monthly">month(s)</option>
                  <option value="yearly">year(s)</option>
                </select>
              </div>
            </div>
          </div>
          <label for="cal-event-desc">Description</label>
          <textarea id="cal-event-desc" placeholder="Notes" autocomplete="off"></textarea>
          <div class="form-actions">
            <button type="button" class="btn" id="cal-event-save">Save</button>
            <button type="button" class="btn secondary" id="cal-event-cancel">Cancel</button>
            <button type="button" class="btn btn-remove" id="cal-event-delete" style="display: none;">Delete</button>
          </div>
        </div>
        </div>
        <div id="calendar-month-view" class="calendar-view"></div>
        <div id="calendar-week-view" class="calendar-view" style="display: none;"></div>
        <div id="calendar-day-view" class="calendar-view" style="display: none;"></div>
      </div>
      <div id="app-sheet-settings" class="app-sheet" data-app="settings">
        <div class="app-sheet-header">
          <button type="button" class="btn app-sheet-back secondary" data-app-back>‚Üê Back to Home</button>
          <h2>Settings</h2>
        </div>
        <div class="settings-layout">
        <nav class="settings-nav">
          <button type="button" data-settings-panel="github" class="active">GitHub Saver</button>
          <button type="button" data-settings-panel="admin" class="">Admin Console</button>
          <button type="button" data-settings-panel="export" class="">Export</button>
          <button type="button" data-settings-panel="backup" class="">Backup</button>
        </nav>
        <div class="settings-content">
          <div id="settings-panel-github" class="settings-panel active">
            <div class="settings-block">
              <h2>GitHub Saver</h2>
              <p class="help">Configure once. Token is kept on this device only. Use <strong>Save settings</strong> below to push this app to GitHub (settings are saved with the file).</p>
              <label for="github_repo">Repository (owner/repo)</label>
              <input type="text" id="github_repo" placeholder="username/HoneyApp" autocomplete="off">
              <label for="github_filename">Filename</label>
              <input type="text" id="github_filename" placeholder="index.html" value="index.html" autocomplete="off">
              <label for="github_branch">Branch</label>
              <input type="text" id="github_branch" placeholder="master" value="master">
              <label for="github_path">Path (optional, e.g. / or /wiki/)</label>
              <input type="text" id="github_path" placeholder="/" autocomplete="off">
              <label for="github_username">Username (GitHub username)</label>
              <input type="text" id="github_username" placeholder="GitHub username" autocomplete="username">
              <label for="github_token">Password (personal access token)</label>
              <input type="password" id="github_token" placeholder="ghp_... or token" autocomplete="off">
              <p class="help">Token is not stored in the file; enter it once per device.</p>
              <p id="settings_status" class="status"></p>
              <button type="button" class="btn" id="btn_publish">Save settings</button>
            </div>
          </div>
          <div id="settings-panel-admin" class="settings-panel">
            <div class="settings-block" id="admin_block">
              <h2>Admin Console</h2>
              <p class="help" id="admin_help" style="display: none;">Add an admin (username and password) to enable encryption. Once added, the app is encrypted and you unlock with that username and password.</p>
              <p class="help" id="admin_locked_msg" style="display: block;">Encryption is on. Unlock with any admin username and password on the home screen. You can add more admins below.</p>
              <div id="admin_table_wrapper" class="admin-table-wrapper">
                <table class="admin-table">
                  <thead><tr><th>Username</th><th>Reset password</th><th>Remove</th></tr></thead>
                  <tbody id="admin_list"></tbody>
                </table>
              </div>
              <p id="admin_status" class="status ok"></p>
              <button type="button" class="btn" id="btn_add_admin">New admin</button>
            </div>
          </div>
          <div id="settings-panel-export" class="settings-panel">
            <div class="settings-block">
              <h2>Export</h2>
              <p class="help">Save the whole app as an HTML document to this device. Use <strong>Save locally</strong> to download the file with your settings.</p>
              <button type="button" class="btn" id="btn_save_locally">Save locally</button>
              <div class="app-placeholder" style="margin-top: 0.5rem;">Placeholder ‚Äî build export here.</div>
            </div>
          </div>
          <div id="settings-panel-backup" class="settings-panel">
            <div class="settings-block">
              <h2>Backup</h2>
              <p class="help">Backup all app data to a file. Optional: import from a previous backup to restore.</p>
              <div class="app-placeholder" style="margin-top: 0.5rem;">Placeholder ‚Äî build backup/restore here.</div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
    </div>
  </div>

  <!-- Add admin / password prompt -->
  <div id="password_wrapper" class="password-wrapper">
    <div class="card">
      <h1 id="password_prompt_title">New admin</h1>
      <form id="password_form" autocomplete="off">
        <label for="password_username" id="label_password_username" style="display: block;">Username</label>
        <input type="text" id="password_username" name="username" placeholder="Username" style="display: block;" autocomplete="username">
        <label for="password_input">Password</label>
        <input type="password" id="password_input" name="password" placeholder="Password" autocomplete="new-password">
        <label for="password_repeat" id="label_password_repeat" style="display: block;">Repeat password</label>
        <input type="password" id="password_repeat" name="password2" placeholder="Repeat password" style="display: block;" autocomplete="new-password">
        <button type="submit" id="password_submit" class="btn">Submit</button>
        <button type="button" id="password_cancel" class="btn secondary" style="display: block;">Cancel</button>
      </form>
      <p id="password_prompt_status" class="status err"></p>
    </div>
  </div>

  <!-- Config: either encrypted blob only (nothing visible) or legacy plaintext -->
  <script type="application/json" id="honey-config">{"encrypted":true,"blobs":[{"salt":"AeCGm2BxQ5QFbHEZFMfL+Q==","iv":"hzf0Kl5GJ7lRYKPh","ciphertext":"UNatugRj1heoprffvDQxagwUFGc/dbF7CX1N+Ui+CvGBpBbwLU37VLiqj/OnXzrUWbcTdRB2aP6KBvjyV6U365LENfm9AUJyY0ZPQljfNqbIlYuu9NMxyQGx58x8g9+VyZABa4zmK41n50ySzNg9bgd6w6DppqjIMMuFErqweddR5UIzxZNyPmitJ5UmapoDKULybhZAdg1nWfqU8DUCXepxC9QM"}]}</script>

  <script>
(function () {
  'use strict';
  var $ = function (id) { return document.getElementById(id); };
  var sessionPassphrase = null;
  var decryptedConfig = null;
  var sessionBlobIndex = -1;

  // App specs: id, title, full description (for placeholders; build one by one)
  var HONEY_APPS = [
    { id: 'database', title: 'Database', icon: 'üì¶', desc: 'Stores prices for everything you buy or sell: equipment, supplies, and finished products. Each entry has a name, category (e.g. equipment / supplies / product), price, and optional notes. Single source of truth for unit costs so Cost calculator, Inventory, and Sales log can reference it. Features: add, edit, delete entries; list and filter by category.' },
    { id: 'projects', title: 'Projects', icon: 'üìã', desc: 'Manages multi-step initiatives and their timelines. Each project has a name, optional due date, status (e.g. planning / in progress / done), and can have phases or milestones. For planning and tracking bigger efforts, not day-to-day tasks. Features: create projects, set due dates, update status; optional list of phases or milestones.' },
    { id: 'inventory', title: 'Inventory', icon: 'üìä', desc: 'Tracks stock levels: what you\'ve made or bought (in) and what you\'ve sold or used (out). Each item links to a product or supply (ideally from Database). Records quantity on hand and optional movements (add/remove with reason and date). Features: list items with quantities; log in/out movements; simple current-stock view.' },
    { id: 'graphs', title: 'Graphs', icon: 'üìà', desc: 'Visualizes data from the app, especially sales (from Sales log) and optionally inventory or costs. E.g. sales over time, by product, or simple comparisons. Read-only; no new data entry. Features: one or more charts (e.g. line/bar) driven by Sales log and later other sources.' },
    { id: 'predictions', title: 'Predictions', icon: 'üéØ', desc: 'Set targets (e.g. revenue, units sold, profit) and see what\'s needed to get there (e.g. units to sell, price or cost assumptions). Uses data from Sales log, Database, and optionally Inventory. Features: set target and timeframe; show gap vs current trend and simple "required per day/unit" metrics.' },
    { id: 'cost-calculator', title: 'Cost calculator', icon: 'üßÆ', desc: 'Uses Database prices to compute cost of a recipe or batch: pick items and quantities, app sums total cost (and optional unit cost per output). No new price storage‚Äîonly reads from Database. Features: select items and quantities; show total and optional per-unit cost.' },
    { id: 'orders', title: 'Sales log', icon: 'üõí', desc: 'Logs individual sales: who, when, what product(s), quantity, price/revenue, optional customer or note. Transaction log that Graphs and Predictions use; Inventory may deduct from stock when you record a sale. Features: add/edit sales with date, items, quantities, amounts; list and filter by date or product.' },
    { id: 'suppliers', title: 'Suppliers', icon: 'üè≠', desc: 'Stores supplier info: name, contact (phone/email), optional address, notes, and which items (from Database or Inventory) they supply. For finding who to reorder from; prices stay in Database. Features: add, edit, delete suppliers; link to products/supplies; simple list and search.' },
    { id: 'tasks', title: 'Tasks', icon: '‚úÖ', desc: 'Day-to-day to-dos (e.g. order wax, ship order, update listing). Each task has a title, optional due date, and done/not done. Separate from Projects: tasks are small actionable items; Projects are larger efforts with timelines. Features: add, complete, delete tasks; optional due date and list view.' },
    { id: 'notes', title: 'Notes', icon: 'üìù', desc: 'Freeform text: notes, recipes, procedures, or any text you want to keep. Each note has a title and body; optional tags or categories. No calculations‚Äîjust store and retrieve text. Features: create, edit, delete notes; list by title or tag; simple viewer.' },
    { id: 'calendar', title: 'Calendar', icon: 'üìÖ', desc: 'Shows dates and events (e.g. markets, deliveries, deadlines). Events have title, date, optional time and description. Complements Projects (project due dates) and Tasks (task due dates) with a calendar view. Features: add/edit events; month or week view; optional list view.' },
    { id: 'settings', title: 'Settings', icon: '‚öôÔ∏è', desc: 'Configure GitHub Saver (repo, branch, token), add/remove admins, export data, backup/restore.' }
  ];

  function getDefaultAppData() {
    return {
      database: [],
      projects: [],
      inventory: [],
      orders: [],
      suppliers: [],
      tasks: [],
      notes: [],
      calendar: []
    };
  }

  function ensureAppDataInConfig(cfg) {
    if (!cfg || typeof cfg !== 'object') return cfg;
    var defaults = getDefaultAppData();
    Object.keys(defaults).forEach(function (k) {
      if (!Array.isArray(cfg[k])) cfg[k] = defaults[k];
    });
    return cfg;
  }

  function getConfig() {
    var el = $('honey-config');
    if (!el || !el.textContent) return { github: { repo: '', filename: 'index.html', branch: 'master', path: '/', username: '' }, encryptionEnabled: false, admin: null, admins: [] };
    try {
      var c = JSON.parse(el.textContent);
      if (c.encrypted === true) {
        if (c.blobs && Array.isArray(c.blobs) && c.blobs.length) return { encrypted: true, blobs: c.blobs };
        if (c.salt && c.iv && c.ciphertext) return { encrypted: true, blobs: [{ salt: c.salt, iv: c.iv, ciphertext: c.ciphertext }] };
        return { encrypted: true, blobs: [] };
      }
      c.github = c.github || {};
      c.github.repo = c.github.repo || '';
      c.github.filename = c.github.filename || 'index.html';
      c.github.branch = c.github.branch || 'master';
      c.github.path = c.github.path != null ? c.github.path : '/';
      c.github.username = c.github.username || '';
      if (c.passwordSet !== undefined) { c.encryptionEnabled = !!c.passwordSet; c.admin = c.admin || null; }
      if (!Array.isArray(c.admins)) c.admins = [];
      return c;
    } catch (e) { return { github: { repo: '', filename: 'index.html', branch: 'master', path: '/', username: '' }, encryptionEnabled: false, admin: null, admins: [] }; }
  }

  function getDecryptedConfig() { return decryptedConfig; }

  function setEncryptedConfig(blobOrBlobs) {
    var el = $('honey-config');
    if (!el) return;
    var blobs = Array.isArray(blobOrBlobs) ? blobOrBlobs : [blobOrBlobs];
    el.textContent = JSON.stringify({ encrypted: true, blobs: blobs });
  }

  function getAdminList(config) {
    var c = config || getConfig();
    if (c.encrypted) return [];
    if (c.admins && c.admins.length) return c.admins;
    if (c.admin && c.admin.salt && c.admin.iv && c.admin.ciphertext) return [c.admin];
    return [];
  }

  function hasAnyAdmin(config) {
    var c = config || getConfig();
    if (c.encrypted) return true;
    return getAdminList(c).length > 0;
  }

  function b64enc(buf) {
    var binary = '';
    var bytes = new Uint8Array(buf);
    for (var i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
  }
  function b64dec(str) {
    var binary = atob(str);
    var bytes = new Uint8Array(binary.length);
    for (var i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    return bytes.buffer;
  }

  async function sha256Hex(text) {
    var enc = new TextEncoder();
    var hash = await crypto.subtle.digest('SHA-256', enc.encode(text));
    var h = Array.from(new Uint8Array(hash)).map(function (b) { return ('0' + b.toString(16)).slice(-2); });
    return h.join('');
  }

  async function deriveKey(password, salt) {
    var enc = new TextEncoder();
    var key = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']);
    var bits = await crypto.subtle.deriveBits({ name: 'PBKDF2', salt: salt, iterations: 100000, hash: 'SHA-256' }, key, 256);
    return crypto.subtle.importKey('raw', bits, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
  }

  async function encryptState(state, password) {
    var salt = crypto.getRandomValues(new Uint8Array(16));
    var iv = crypto.getRandomValues(new Uint8Array(12));
    var key = await deriveKey(password, salt);
    var enc = new TextEncoder();
    var ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, enc.encode(JSON.stringify(state)));
    return { salt: b64enc(salt), iv: b64enc(iv), ciphertext: b64enc(ct) };
  }

  async function decryptState(blob, password) {
    var key = await deriveKey(password, new Uint8Array(b64dec(blob.salt)));
    var pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: new Uint8Array(b64dec(blob.iv)) }, key, b64dec(blob.ciphertext));
    return JSON.parse(new TextDecoder().decode(pt));
  }

  function setConfig(config) {
    var el = $('honey-config');
    if (el) el.textContent = JSON.stringify(config);
  }

  function loadConfigIntoForm() {
    var c = decryptedConfig || getConfig();
    if (c.encrypted && !decryptedConfig) return;
    var g = c.github || {};
    if ($('github_repo')) $('github_repo').value = g.repo || '';
    if ($('github_filename')) $('github_filename').value = g.filename || 'index.html';
    if ($('github_branch')) $('github_branch').value = g.branch || 'master';
    if ($('github_path')) $('github_path').value = g.path != null ? g.path : '/';
    if ($('github_username')) $('github_username').value = g.username || '';
    if ($('github_token')) $('github_token').value = ''; // never prefill token
  }

  function getToken() {
    var input = $('github_token') && $('github_token').value;
    if (input && input.trim() && input !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') return input.trim();
    try { return localStorage.getItem('honey_github_token') || ''; } catch (e) { return ''; }
  }

  function githubAuthHeaders(token) {
    var auth = (token && token.indexOf('ghp_') === 0) ? 'token ' + token : 'Bearer ' + (token || '');
    return { 'Authorization': auth, 'Accept': 'application/vnd.github+json', 'X-GitHub-Api-Version': '2022-11-28' };
  }

  async function validateGitHubToken(token) {
    if (!token || !token.trim()) return { ok: false, message: 'Enter a token.' };
    if (!navigator.onLine) return { ok: false, message: 'No internet. Check connection and try again.' };
    try {
      var res = await fetch('https://api.github.com/user', { headers: githubAuthHeaders(token.trim()) });
      if (res.ok) return { ok: true };
      if (res.status === 401 || res.status === 403) return { ok: false, message: 'Token is invalid or expired.' };
      return { ok: false, message: 'Token check failed. Try again.' };
    } catch (e) {
      return { ok: false, message: 'Could not check token. Check your connection.' };
    }
  }

  async function tryShowAppOrTokenGate() {
    var token = getToken();
    if (!token) {
      showScreen('screen-token-gate');
      if ($('token_gate_status')) { $('token_gate_status').textContent = ''; $('token_gate_status').className = 'status'; }
      return;
    }
    var result = await validateGitHubToken(token);
    if (result.ok) {
      showScreen('screen-app');
      showHomeTab();
      return;
    }
    try { localStorage.removeItem('honey_github_token'); } catch (e) {}
    showScreen('screen-token-gate');
    if ($('token_gate_status')) { $('token_gate_status').textContent = result.message; $('token_gate_status').className = 'status err'; }
  }

  async function saveToGitHub() {
    var statusEl = $('settings_status') || $('github_status');
    function setStatus(msg, ok) {
      if (statusEl) { statusEl.textContent = msg || ''; statusEl.className = 'status' + (ok === true ? ' ok' : ok === false ? ' err' : ''); }
    }
    saveSettingsToConfig();
    if (decryptedConfig && sessionPassphrase) {
      try {
        var blob = await encryptState(decryptedConfig, sessionPassphrase);
        var cfg = getConfig();
        var blobs = (cfg.blobs || []).slice();
        if (sessionBlobIndex >= 0 && sessionBlobIndex < blobs.length) blobs[sessionBlobIndex] = blob;
        else blobs = [blob];
        setEncryptedConfig(blobs);
      } catch (e) { setStatus('Encryption failed.', false); return; }
    }
    var config = getDecryptedConfig() || getConfig();
    var g = config.github || {};
    var repo = (g.repo || '').trim();
    var filename = (g.filename || 'index.html').trim();
    var branch = (g.branch || 'master').trim();
    var pathStr = (g.path != null ? g.path : '/').trim();
    if (pathStr === '') pathStr = '/';
    var tokenFromInput = ($('github_token') && $('github_token').value || '').trim();
    if (tokenFromInput && tokenFromInput !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') try { localStorage.setItem('honey_github_token', tokenFromInput); } catch (e) {}
    var pathNorm = pathStr.replace(/^\//, '').replace(/\/$/, '');
    var filePath = pathNorm ? pathNorm + '/' + filename : filename;
    var token = getToken();
    if (!repo || !token) {
      setStatus('Enter repository (owner/repo) and token, then Save settings.', false);
      return;
    }
    var parts = repo.split('/').map(function (s) { return s.trim(); });
    var owner = parts[0];
    var repoName = parts[1];
    if (!owner || !repoName) {
      setStatus('Repository must be owner/repo (e.g. username/HoneyApp).', false);
      return;
    }
    if (!navigator.onLine) {
      setStatus('Need internet to save to GitHub.', false);
      return;
    }
    setStatus('Saving to GitHub‚Ä¶', null);
    var branchToUse = branch;
    try {
      var repoRes = await fetch('https://api.github.com/repos/' + owner + '/' + repoName, { headers: githubAuthHeaders(token) });
      if (repoRes.ok) {
        var repoJson = await repoRes.json();
        if (repoJson.default_branch) branchToUse = repoJson.default_branch;
      }
    } catch (e) {}
    var tokenInput = $('github_token');
    var prevTokenVal = tokenInput ? tokenInput.value : '';
    if (tokenInput) tokenInput.value = '';
    var html = document.documentElement.outerHTML;
    if (tokenInput) tokenInput.value = prevTokenVal;
    var content = btoa(unescape(encodeURIComponent(html)));
    var sha = null;
    try {
      var r = await fetch('https://api.github.com/repos/' + owner + '/' + repoName + '/contents/' + encodeURIComponent(filePath) + '?ref=' + encodeURIComponent(branchToUse), { headers: githubAuthHeaders(token) });
      if (r.ok) { var j = await r.json(); sha = j.sha; }
    } catch (e) {}
    try {
      var putRes = await fetch('https://api.github.com/repos/' + owner + '/' + repoName + '/contents/' + encodeURIComponent(filePath), {
        method: 'PUT',
        headers: Object.assign({ 'Content-Type': 'application/json' }, githubAuthHeaders(token)),
        body: JSON.stringify({ message: 'HoneyApp save', content: content, sha: sha || undefined, branch: branchToUse })
      });
      if (!putRes.ok) {
        var errJson = await putRes.json();
        throw new Error(errJson.message || putRes.statusText);
      }
      setStatus('Saved to GitHub.', true);
        setTimeout(function () { setStatus(''); }, 3000);
    } catch (e) {
      setStatus('Save failed: ' + (e.message || e), false);
    }
  }

  // Password prompt
  var passwordPrompt = {
    wrapper: null,
    options: null,
    show: function (opts) {
      this.options = opts || {};
      this.wrapper = $('password_wrapper');
      if (!$('password_prompt_title')) return;
      $('password_prompt_title').textContent = this.options.serviceName || 'Enter password';
      $('password_input').value = '';
      $('password_repeat').value = '';
      if ($('password_username')) $('password_username').value = '';
      var showUser = !this.options.noUserName;
      if ($('label_password_username')) $('label_password_username').style.display = showUser ? 'block' : 'none';
      if ($('password_username')) $('password_username').style.display = showUser ? 'block' : 'none';
      var repeat = !!this.options.repeatPassword;
      $('label_password_repeat').style.display = repeat ? 'block' : 'none';
      $('password_repeat').style.display = repeat ? 'block' : 'none';
      $('password_cancel').style.display = this.options.canCancel ? 'block' : 'none';
      $('password_prompt_status').textContent = '';
      if (this.wrapper) this.wrapper.classList.add('active');
      setTimeout(function () { if (showUser && $('password_username')) $('password_username').focus(); else if ($('password_input')) $('password_input').focus(); }, 50);
    },
    hide: function () {
      if (this.wrapper) this.wrapper.classList.remove('active');
    },
    submit: function (data) {
      var self = this;
      var cb = this.options && this.options.callback;
      if (cb && data) {
        var remove = cb(data);
        if (remove) self.hide();
      } else if (this.options && this.options.callback && !data) {
        this.options.callback(null);
        self.hide();
      }
    }
  };

  if ($('password_form')) {
    $('password_form').addEventListener('submit', function (e) {
      e.preventDefault();
      var repeat = passwordPrompt.options && passwordPrompt.options.repeatPassword;
      var p1 = $('password_input') && $('password_input').value;
      var p2 = $('password_repeat') && $('password_repeat').value;
      if (repeat && p1 !== p2) {
        $('password_prompt_status').textContent = 'Passwords do not match.';
        $('password_prompt_status').className = 'status err';
        return;
      }
      var usernameEl = $('password_username');
      var username = (usernameEl && usernameEl.value || '').trim();
      passwordPrompt.submit({ username: username, password: p1 });
    });
  }
  if ($('password_cancel')) {
    $('password_cancel').addEventListener('click', function () {
      passwordPrompt.submit(null);
    });
  }

  function showHomeView(view) {
    var grid = $('home-app-grid');
    var sheets = document.querySelectorAll('#sheet-home .app-sheet');
    closeCalendarNewEventModal();
    closeTasksNewTaskModal();
    if (view === 'grid') {
      if (grid) grid.style.display = '';
      sheets.forEach(function (s) { s.classList.remove('active'); });
      updateHomeHeader();
    } else {
      if (grid) grid.style.display = 'none';
      sheets.forEach(function (s) {
        s.classList.toggle('active', s.getAttribute('data-app') === view);
      });
      if (view === 'calendar') calendarInit();
      if (view === 'tasks') tasksInit();
      if (view === 'notes') notesInit();
      if (view === 'settings') { loadConfigIntoForm(); loadTokenIntoForm(); var se = $('settings_status'); if (se) se.textContent = ''; var ae = $('admin_status'); if (ae) ae.textContent = ''; }
    }
  }

  function updateHomeHeader() {
    var el = $('home-header');
    if (!el) return;
    var now = new Date();
    var todayKey = formatDateKey(now);
    var dayOfWeek = now.getDay();
    var daysToSunday = dayOfWeek === 0 ? 0 : (7 - dayOfWeek);
    var sundayDate = addDays(now, daysToSunday);
    var endOfWeekKey = formatDateKey(sundayDate);
    var tomorrowDate = addDays(now, 1);
    var tomorrowKey = formatDateKey(tomorrowDate);
    var todayEvents = getEventsForDate(todayKey).slice().sort(function (a, b) {
      var t1 = (a.time || '').trim();
      var t2 = (b.time || '').trim();
      if (!t1 && !t2) return 0;
      if (!t1) return 1;
      if (!t2) return -1;
      return t1.localeCompare(t2);
    });
    var todayTasks = [];
    try {
      todayTasks = getTasks().filter(function (t) {
        var k = (t.date || '').substring(0, 10);
        return k === todayKey && !t.completed;
      }).slice().sort(function (a, b) {
        var t1 = (a.time || '').trim();
        var t2 = (b.time || '').trim();
        if (!t1 && !t2) return 0;
        if (!t1) return 1;
        if (!t2) return -1;
        return t1.localeCompare(t2);
      });
    } catch (e) {}
    var upcomingInstances = tomorrowKey <= endOfWeekKey ? getEventInstancesInRange(tomorrowKey, endOfWeekKey) : [];
    upcomingInstances.sort(function (a, b) {
      if (a.instanceDate !== b.instanceDate) return a.instanceDate.localeCompare(b.instanceDate);
      var t1 = (a.event.time || '').trim();
      var t2 = (b.event.time || '').trim();
      if (!t1 && !t2) return 0;
      if (!t1) return 1;
      if (!t2) return -1;
      return t1.localeCompare(t2);
    });
    var upcomingTasks = [];
    try {
      upcomingTasks = getTasks().filter(function (t) {
        var k = (t.date || '').substring(0, 10);
        return k && k > todayKey && k <= endOfWeekKey && !t.completed;
      }).slice().sort(function (a, b) {
        var k1 = (a.date || '').substring(0, 10);
        var k2 = (b.date || '').substring(0, 10);
        if (k1 !== k2) return k1.localeCompare(k2);
        var t1 = (a.time || '').trim();
        var t2 = (b.time || '').trim();
        if (!t1 && !t2) return 0;
        if (!t1) return 1;
        if (!t2) return -1;
        return t1.localeCompare(t2);
      });
    } catch (e) {}
    var hasContent = todayEvents.length > 0 || todayTasks.length > 0 || upcomingInstances.length > 0 || upcomingTasks.length > 0;
    if (!hasContent) {
      el.classList.add('empty');
      el.innerHTML = '';
      return;
    }
    el.classList.remove('empty');
    var dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    var leftHtml = '<div class="home-header-col"><div class="home-col-title">Today</div>';
    if (todayEvents.length > 0 || todayTasks.length > 0) {
      leftHtml += '<ul class="home-today-events">';
      todayEvents.forEach(function (ev) {
        leftHtml += '<li class="home-today-event"><span class="home-event-pill" data-type="event" data-event-id="' + escapeHtml(ev.id || '') + '" data-date="' + escapeHtml(todayKey) + '"><strong>EVENT</strong> - ' + escapeHtml(ev.title || '') + '</span></li>';
      });
      todayTasks.forEach(function (t) {
        var pri = (t.priority || 'low');
        leftHtml += '<li class="home-today-event"><span class="home-task-pill priority-' + escapeHtml(pri) + '" data-type="task" data-task-id="' + escapeHtml(t.id || '') + '" data-date="' + escapeHtml(todayKey) + '"><strong>TASK</strong> - ' + escapeHtml(t.title || '') + '</span></li>';
      });
      leftHtml += '</ul>';
    } else {
      leftHtml += '<div class="home-today-empty">Nothing today</div>';
    }
    leftHtml += '</div>';
    var rightHtml = '<div class="home-header-col"><div class="home-col-title">Upcoming this week</div>';
    if (upcomingInstances.length > 0 || upcomingTasks.length > 0) {
      rightHtml += '<ul class="home-upcoming-events">';
      upcomingInstances.forEach(function (item) {
        var ev = item.event;
        var instanceD = parseDateKey(item.instanceDate);
        var dayLabel = instanceD ? dayLabels[instanceD.getDay()] : '';
        rightHtml += '<li class="home-upcoming-event"><span class="home-event-day">' + escapeHtml(dayLabel) + '</span> <span class="home-event-pill" data-type="event" data-event-id="' + escapeHtml(ev.id || '') + '" data-date="' + escapeHtml(item.instanceDate || '') + '"><strong>EVENT</strong> - ' + escapeHtml(ev.title || '') + '</span></li>';
      });
      upcomingTasks.forEach(function (t) {
        var k = (t.date || '').substring(0, 10);
        var d = parseDateKey(k);
        var dayLabel = d ? dayLabels[d.getDay()] : '';
        var pri = (t.priority || 'low');
        rightHtml += '<li class="home-upcoming-event"><span class="home-event-day">' + escapeHtml(dayLabel) + '</span> <span class="home-task-pill priority-' + escapeHtml(pri) + '" data-type="task" data-task-id="' + escapeHtml(t.id || '') + '" data-date="' + escapeHtml(k || '') + '"><strong>TASK</strong> - ' + escapeHtml(t.title || '') + '</span></li>';
      });
      rightHtml += '</ul>';
    } else {
      rightHtml += '<div class="home-upcoming-empty">Nothing upcoming</div>';
    }
    rightHtml += '</div>';
    el.innerHTML = leftHtml + rightHtml;
  }

  // --- Calendar app ---
  var calendarState = { currentDate: new Date(), viewMode: 'month', editingEventId: null };
  function getCalendarEvents() {
    var cfg = getDecryptedConfig();
    if (!cfg || !Array.isArray(cfg.calendar)) return [];
    return cfg.calendar;
  }
  function formatDateKey(d) {
    var y = d.getFullYear();
    var m = (d.getMonth() + 1);
    var day = d.getDate();
    return y + '-' + (m < 10 ? '0' + m : m) + '-' + (day < 10 ? '0' + day : day);
  }
  function parseDateKey(key) {
    var parts = key.split('-');
    if (parts.length !== 3) return null;
    var d = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
    return isNaN(d.getTime()) ? null : d;
  }
  function getRepeatSpec(ev) {
    var r = ev.repeat;
    if (!r) return null;
    if (typeof r === 'object' && r.frequency && r.interval) return { frequency: r.frequency, interval: Math.max(1, Math.min(99, parseInt(r.interval, 10) || 1)) };
    if (r === 'biweekly') return { frequency: 'weekly', interval: 2 };
    if (r === 'daily' || r === 'weekly' || r === 'monthly' || r === 'yearly') return { frequency: r, interval: 1 };
    return null;
  }
  function addDays(d, n) {
    var copy = new Date(d);
    copy.setDate(copy.getDate() + n);
    return copy;
  }
  function addMonths(d, n) {
    var copy = new Date(d);
    var day = copy.getDate();
    copy.setMonth(copy.getMonth() + n);
    if (copy.getDate() !== day) {
      copy.setMonth(copy.getMonth() + 1);
      copy.setDate(0);
    }
    return copy;
  }
  function addYears(d, n) {
    var copy = new Date(d);
    copy.setFullYear(copy.getFullYear() + n);
    return copy;
  }
  function getEventInstancesInRange(startKey, endKey) {
    var events = getCalendarEvents();
    var startD = parseDateKey(startKey);
    var endD = parseDateKey(endKey);
    if (!startD || !endD) return [];
    var result = [];
    var maxIter = 5000;
    events.forEach(function (ev) {
      var evStart = (ev.date || '').substring(0, 10);
      if (!evStart) return;
      var spec = getRepeatSpec(ev);
      if (!spec) {
        if (evStart >= startKey && evStart <= endKey) result.push({ event: ev, instanceDate: evStart });
        return;
      }
      var d = parseDateKey(evStart);
      if (!d || d.getTime() > endD.getTime()) return;
      var count = 0;
      while (d.getTime() <= endD.getTime() && count < maxIter) {
        var key = formatDateKey(d);
        if (key >= startKey && key <= endKey) result.push({ event: ev, instanceDate: key });
        count++;
        if (spec.frequency === 'daily') d = addDays(d, spec.interval);
        else if (spec.frequency === 'weekly') d = addDays(d, 7 * spec.interval);
        else if (spec.frequency === 'monthly') d = addMonths(d, spec.interval);
        else if (spec.frequency === 'yearly') d = addYears(d, spec.interval);
        else d = addDays(d, spec.interval);
      }
    });
    return result;
  }
  function getEventsForDate(dateKey) {
    var instances = getEventInstancesInRange(dateKey, dateKey);
    return instances.map(function (x) { return x.event; });
  }
  function getEventsInRange(startKey, endKey) {
    return getEventInstancesInRange(startKey, endKey).map(function (x) { return x.event; });
  }
  function isToday(d) { return formatDateKey(d) === formatDateKey(new Date()); }
  function parseTimeToHour(timeStr) {
    if (!timeStr || !(timeStr = (timeStr + '').trim())) return 0;
    var parts = timeStr.split(':');
    var h = parseInt(parts[0], 10) || 0;
    var m = parts[1] ? parseInt(parts[1], 10) || 0 : 0;
    return h + m / 60;
  }
  function isOtherMonth(d, year, month) { return d.getFullYear() !== year || d.getMonth() !== month; }
  function calendarUpdateLabel() {
    var el = $('calendar-label');
    if (!el) return;
    var d = calendarState.currentDate;
    var mode = calendarState.viewMode;
    if (mode === 'month') el.textContent = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    else if (mode === 'week') {
      var start = getWeekStart(d);
      var end = new Date(start);
      end.setDate(end.getDate() + 6);
      el.textContent = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ‚Äì ' + end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    } else el.textContent = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
  }
  function calendarFixLabelWidth() {
    var el = $('calendar-label');
    if (!el || el.dataset.calLabelWidthFixed) return;
    var longestDay = new Date(2026, 8, 30).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    var longestWeekStart = new Date(2026, 11, 28);
    var longestWeekEnd = new Date(2026, 11, 31);
    var longestWeek = longestWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ‚Äì ' + longestWeekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    var longestMonth = new Date(2026, 8, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    var measure = document.createElement('span');
    measure.style.cssText = 'position:absolute;left:-9999px;top:0;visibility:hidden;font-weight:600;font-size:0.95rem;white-space:nowrap;';
    measure.textContent = longestDay;
    document.body.appendChild(measure);
    var wDay = measure.offsetWidth;
    measure.textContent = longestWeek;
    var wWeek = measure.offsetWidth;
    measure.textContent = longestMonth;
    var wMonth = measure.offsetWidth;
    document.body.removeChild(measure);
    var w = Math.max(wDay, wWeek, wMonth);
    if (window.innerWidth <= 767) w = Math.min(w, 215);
    el.style.minWidth = w + 'px';
    el.dataset.calLabelWidthFixed = '1';
  }
  function getWeekStart(d) {
    var copy = new Date(d);
    var day = copy.getDay();
    var diff = copy.getDate() - day + (day === 0 ? -6 : 1);
    copy.setDate(diff);
    return copy;
  }
  function renderMonth() {
    var el = $('calendar-month-view');
    if (!el) return;
    var d = calendarState.currentDate;
    var year = d.getFullYear();
    var month = d.getMonth();
    var first = new Date(year, month, 1);
    var startDay = first.getDay();
    var startOffset = startDay === 0 ? 6 : startDay - 1;
    var daysInMonth = new Date(year, month + 1, 0).getDate();
    var prevMonth = new Date(year, month, 0);
    var prevDays = prevMonth.getDate();
    var html = '';
    var weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    weekdays.forEach(function (w) { html += '<div class="cal-weekday">' + escapeHtml(w) + '</div>'; });
    var dayCount = 0;
    var totalCells = Math.ceil((startOffset + daysInMonth) / 7) * 7;
    for (var i = 0; i < totalCells; i++) {
      var cellDate;
      var other = false;
      if (i < startOffset) {
        cellDate = new Date(year, month - 1, prevDays - startOffset + i + 1);
        other = true;
      } else if (dayCount < daysInMonth) {
        dayCount++;
        cellDate = new Date(year, month, dayCount);
      } else {
        cellDate = new Date(year, month + 1, dayCount - daysInMonth + 1);
        other = true;
      }
      var key = formatDateKey(cellDate);
      var events = getEventsForDate(key);
      var cls = 'cal-day';
      if (other) cls += ' other-month';
      if (isToday(cellDate)) cls += ' today';
      html += '<div class="' + cls + '" data-date="' + escapeHtml(key) + '">';
      html += '<div class="cal-day-num">' + cellDate.getDate() + '</div>';
      html += '<div class="cal-day-events">';
      events.slice(0, 3).forEach(function (ev) {
        var tip = (ev.title || '') + ((ev.time || '').trim() ? ' ' + (ev.time || '').trim() : '') + ((ev.endTime || '').trim() ? ' ‚Äì ' + (ev.endTime || '').trim() : '') + ((ev.location || '').trim() ? ' @ ' + (ev.location || '').trim() : '') + (getRepeatSpec(ev) ? ' (repeats)' : '');
        html += '<span class="cal-event-dot" data-event-id="' + escapeHtml(ev.id || '') + '" title="' + escapeHtml(tip) + '">' + escapeHtml((ev.time || '').trim() ? (ev.time + ' ') : '') + escapeHtml(ev.title || '') + '</span>';
      });
      if (events.length > 3) html += '<span class="cal-event-dot">+' + (events.length - 3) + '</span>';
      html += '</div></div>';
    }
    el.innerHTML = '<div class="calendar-month">' + html + '</div>';
    el.style.display = '';
  }
  function renderWeek() {
    var el = $('calendar-week-view');
    if (!el) return;
    var d = calendarState.currentDate;
    var start = getWeekStart(d);
    var html = '<div class="calendar-week">';
    for (var i = 0; i < 7; i++) {
      var cellDate = new Date(start);
      cellDate.setDate(start.getDate() + i);
      var key = formatDateKey(cellDate);
      var events = getEventsForDate(key);
      var cls = 'cal-day-col';
      if (cellDate.getMonth() !== start.getMonth()) cls += ' other-month';
      if (isToday(cellDate)) cls += ' today';
      html += '<div class="' + cls + '" data-date="' + escapeHtml(key) + '">';
      html += '<div class="cal-day-header">' + cellDate.toLocaleDateString('en-US', { weekday: 'short' }) + ' ' + cellDate.getDate() + '</div>';
      html += '<div class="cal-day-events">';
      events.forEach(function (ev) {
        var tip = (ev.title || '') + ((ev.time || '').trim() ? ' ' + (ev.time || '').trim() : '') + ((ev.endTime || '').trim() ? ' ‚Äì ' + (ev.endTime || '').trim() : '') + ((ev.location || '').trim() ? ' @ ' + (ev.location || '').trim() : '') + (getRepeatSpec(ev) ? ' (repeats)' : '');
        html += '<div class="cal-event-dot" data-event-id="' + escapeHtml(ev.id || '') + '" title="' + escapeHtml(tip) + '">' + escapeHtml((ev.time || '').trim() ? (ev.time + ' ') : '') + escapeHtml(ev.title || '') + '</div>';
      });
      html += '</div></div>';
    }
    html += '</div>';
    el.innerHTML = html;
    el.style.display = '';
  }
  function renderDay() {
    var el = $('calendar-day-view');
    if (!el) return;
    var d = calendarState.currentDate;
    var key = formatDateKey(d);
    var events = getEventsForDate(key).slice().sort(function (a, b) {
      var t1 = (a.time || '').trim();
      var t2 = (b.time || '').trim();
      if (!t1 && !t2) return 0;
      if (!t1) return 1;
      if (!t2) return -1;
      return t1.localeCompare(t2);
    });
    var html = '<div class="calendar-day">';
    html += '<div class="cal-day-header">' + d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) + '</div>';
    html += '<div class="calendar-day-wrap">';
    html += '<div class="calendar-day-list">';
    events.forEach(function (ev) {
      var timeStr = (ev.time || '').trim();
      if ((ev.endTime || '').trim()) timeStr = timeStr ? (timeStr + ' ‚Äì ' + (ev.endTime || '').trim()) : ('‚Äì ' + (ev.endTime || '').trim());
      if (!timeStr) timeStr = '‚Äî';
      html += '<div class="cal-event-item" data-event-id="' + escapeHtml(ev.id || '') + '"><span class="cal-event-time">' + escapeHtml(timeStr) + '</span>' + escapeHtml(ev.title || '') + (ev.location ? ' <span class="cal-event-location">@ ' + escapeHtml(ev.location) + '</span>' : '') + (getRepeatSpec(ev) ? ' <span class="help">(repeats)</span>' : '') + (ev.description ? '<br><span class="help">' + escapeHtml(ev.description) + '</span>' : '') + '</div>';
    });
    if (!events.length) html += '<p class="help">No events this day.</p>';
    html += '</div></div></div>';
    el.innerHTML = html;
    el.style.display = '';
  }
  function showCalendarView(mode) {
    calendarState.viewMode = mode;
    var monthEl = $('calendar-month-view');
    var weekEl = $('calendar-week-view');
    var dayEl = $('calendar-day-view');
    if (monthEl) monthEl.style.display = mode === 'month' ? '' : 'none';
    if (weekEl) weekEl.style.display = mode === 'week' ? '' : 'none';
    if (dayEl) dayEl.style.display = mode === 'day' ? '' : 'none';
    document.querySelectorAll('.calendar-view-switcher button').forEach(function (b) {
      b.classList.toggle('active', (b.getAttribute('data-cal-view') || '') === mode);
    });
    calendarUpdateLabel();
    calendarFixLabelWidth();
    if (mode === 'month') renderMonth();
    else if (mode === 'week') renderWeek();
    else renderDay();
  }
  function calendarShowForm(ev) {
    var wrap = $('calendar-event-form-wrap');
    var saveBtn = $('cal-event-save');
    var delBtn = $('cal-event-delete');
    var customWrap = $('cal-repeat-custom-wrap');
    if (!wrap) return;
    if (ev) ensureCalendarFormInList();
    if (ev) {
      calendarState.editingEventId = ev.id;
      if ($('cal-event-title')) $('cal-event-title').value = ev.title || '';
      if ($('cal-event-date')) $('cal-event-date').value = (ev.date || '').substring(0, 10) || '';
      if ($('cal-event-time')) $('cal-event-time').value = (ev.time || '').trim().substring(0, 5) || '';
      if ($('cal-event-end-date')) $('cal-event-end-date').value = (ev.endDate || '').substring(0, 10) || '';
      if ($('cal-event-end-time')) $('cal-event-end-time').value = (ev.endTime || '').trim().substring(0, 5) || '';
      if ($('cal-event-location')) $('cal-event-location').value = ev.location || '';
      if ($('cal-event-desc')) $('cal-event-desc').value = ev.description || '';
      var rep = ev.repeat;
      var repeatVal = '';
      if (rep && typeof rep === 'object' && rep.frequency && rep.interval) repeatVal = 'custom';
      else if (rep === 'daily' || rep === 'weekly' || rep === 'biweekly' || rep === 'monthly' || rep === 'yearly') repeatVal = rep;
      if ($('cal-event-repeat')) $('cal-event-repeat').value = repeatVal;
      if (repeatVal === 'custom' && rep && rep.interval) {
        if ($('cal-repeat-interval')) $('cal-repeat-interval').value = Math.max(1, Math.min(99, parseInt(rep.interval, 10) || 1));
        if ($('cal-repeat-frequency')) $('cal-repeat-frequency').value = rep.frequency || 'weekly';
      }
      if (customWrap) customWrap.style.display = repeatVal === 'custom' ? 'flex' : 'none';
      if (saveBtn) saveBtn.textContent = 'Update';
      if (delBtn) delBtn.style.display = '';
    } else {
      calendarState.editingEventId = null;
      var today = new Date();
      var key = formatDateKey(today);
      var nextQuarter = Math.ceil(today.getMinutes() / 15) * 15;
      var startH = today.getHours();
      if (nextQuarter >= 60) { nextQuarter = 0; startH += 1; }
      if (startH >= 24) startH = 0;
      var startTime = (startH < 10 ? '0' : '') + startH + ':' + (nextQuarter < 10 ? '0' : '') + nextQuarter;
      var endH = startH + 1;
      if (endH >= 24) endH = 0;
      var endTime = (endH < 10 ? '0' : '') + endH + ':' + (nextQuarter < 10 ? '0' : '') + nextQuarter;
      if ($('cal-event-title')) $('cal-event-title').value = '';
      if ($('cal-event-date')) $('cal-event-date').value = key;
      if ($('cal-event-time')) $('cal-event-time').value = startTime;
      if ($('cal-event-end-date')) $('cal-event-end-date').value = key;
      if ($('cal-event-end-time')) $('cal-event-end-time').value = endTime;
      if ($('cal-event-location')) $('cal-event-location').value = '';
      if ($('cal-event-desc')) $('cal-event-desc').value = '';
      if ($('cal-event-repeat')) $('cal-event-repeat').value = '';
      if ($('cal-repeat-interval')) $('cal-repeat-interval').value = '1';
      if ($('cal-repeat-frequency')) $('cal-repeat-frequency').value = 'weekly';
      if (customWrap) customWrap.style.display = 'none';
      if (saveBtn) saveBtn.textContent = 'Save';
      if (delBtn) delBtn.style.display = 'none';
    }
    wrap.style.display = 'block';
  }
  function calendarHideForm() {
    var wrap = $('calendar-event-form-wrap');
    if (wrap) wrap.style.display = 'none';
    calendarState.editingEventId = null;
  }
  function ensureCalendarFormInList() {
    var formWrap = $('calendar-event-form-wrap');
    var content = $('calendar-new-event-content');
    var placeholder = $('calendar-event-form-placeholder');
    var modalWrap = $('calendar-new-event-wrapper');
    if (formWrap && content && placeholder && formWrap.parentElement === content) {
      placeholder.appendChild(formWrap);
      if (modalWrap) { modalWrap.classList.remove('active'); modalWrap.setAttribute('aria-hidden', 'true'); }
    }
  }
  function openCalendarNewEventModal() {
    var formWrap = $('calendar-event-form-wrap');
    var content = $('calendar-new-event-content');
    var placeholder = $('calendar-event-form-placeholder');
    var modalWrap = $('calendar-new-event-wrapper');
    if (!formWrap || !content || !placeholder || !modalWrap) return;
    content.appendChild(formWrap);
    modalWrap.classList.add('active');
    modalWrap.setAttribute('aria-hidden', 'false');
    calendarShowForm(null);
  }
  function closeCalendarNewEventModal() {
    var formWrap = $('calendar-event-form-wrap');
    var content = $('calendar-new-event-content');
    var placeholder = $('calendar-event-form-placeholder');
    var modalWrap = $('calendar-new-event-wrapper');
    if (formWrap && content && placeholder && modalWrap && formWrap.parentElement === content) {
      placeholder.appendChild(formWrap);
      modalWrap.classList.remove('active');
      modalWrap.setAttribute('aria-hidden', 'true');
    }
  }
  function calendarSaveEvent() {
    var title = ($('cal-event-title') && $('cal-event-title').value || '').trim();
    var dateVal = ($('cal-event-date') && $('cal-event-date').value || '').trim().substring(0, 10);
    var timeVal = ($('cal-event-time') && $('cal-event-time').value || '').trim().substring(0, 5);
    var endDateVal = ($('cal-event-end-date') && $('cal-event-end-date').value || '').trim().substring(0, 10);
    var endTimeVal = ($('cal-event-end-time') && $('cal-event-end-time').value || '').trim().substring(0, 5);
    var locationVal = ($('cal-event-location') && $('cal-event-location').value || '').trim();
    var desc = ($('cal-event-desc') && $('cal-event-desc').value || '').trim();
    var repeatVal = ($('cal-event-repeat') && $('cal-event-repeat').value || '').trim();
    var repeat = null;
    if (repeatVal === 'custom') {
      var interval = Math.max(1, Math.min(99, parseInt(($('cal-repeat-interval') && $('cal-repeat-interval').value) || '1', 10)));
      var freq = ($('cal-repeat-frequency') && $('cal-repeat-frequency').value) || 'weekly';
      repeat = { frequency: freq, interval: interval };
    } else if (repeatVal) repeat = repeatVal;
    if (!title || !dateVal) return false;
    var cfg = getDecryptedConfig();
    if (!cfg) return false;
    cfg.calendar = cfg.calendar || [];
    var payload = { id: null, title: title, date: dateVal, time: timeVal, endDate: endDateVal || undefined, endTime: endTimeVal || undefined, location: locationVal || undefined, description: desc || undefined, repeat: repeat || undefined };
    var id = calendarState.editingEventId;
    if (id) {
      payload.id = id;
      var idx = cfg.calendar.findIndex(function (e) { return e.id === id; });
      if (idx !== -1) cfg.calendar[idx] = payload;
    } else {
      payload.id = Date.now() + '-' + Math.random().toString(36).slice(2, 9);
      cfg.calendar.push(payload);
    }
    calendarHideForm();
    showCalendarView(calendarState.viewMode);
    return true;
  }
  function calendarDeleteEvent() {
    var id = calendarState.editingEventId;
    if (!id) return;
    var cfg = getDecryptedConfig();
    if (cfg && Array.isArray(cfg.calendar)) cfg.calendar = cfg.calendar.filter(function (e) { return e.id !== id; });
    calendarHideForm();
    showCalendarView(calendarState.viewMode);
  }
  function calendarNavigate(delta) {
    var d = calendarState.currentDate;
    var mode = calendarState.viewMode;
    var next = new Date(d);
    if (mode === 'month') next.setMonth(next.getMonth() + delta);
    else if (mode === 'week') next.setDate(next.getDate() + (delta * 7));
    else next.setDate(next.getDate() + delta);
    calendarState.currentDate = next;
    calendarUpdateLabel();
    if (mode === 'month') renderMonth();
    else if (mode === 'week') renderWeek();
    else renderDay();
  }
  function calendarInit() {
    var cfg = getDecryptedConfig();
    if (cfg && !Array.isArray(cfg.calendar)) cfg.calendar = [];
    calendarState.currentDate = new Date();
    calendarState.viewMode = 'month';
    calendarUpdateLabel();
    showCalendarView('month');
  }
  if ($('calendar-prev')) $('calendar-prev').addEventListener('click', function () { calendarNavigate(-1); });
  if ($('calendar-next')) $('calendar-next').addEventListener('click', function () { calendarNavigate(1); });
  document.querySelectorAll('.calendar-view-switcher button').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var mode = btn.getAttribute('data-cal-view') || 'month';
      calendarState.viewMode = mode;
      showCalendarView(mode);
    });
  });
  if ($('cal-event-repeat')) $('cal-event-repeat').addEventListener('change', function () {
    var wrap = $('cal-repeat-custom-wrap');
    if (wrap) wrap.style.display = (this.value === 'custom') ? 'flex' : 'none';
  });
  if ($('calendar-add-event')) $('calendar-add-event').addEventListener('click', openCalendarNewEventModal);
  if ($('cal-event-save')) $('cal-event-save').addEventListener('click', function () { if (calendarSaveEvent()) closeCalendarNewEventModal(); });
  if ($('cal-event-cancel')) $('cal-event-cancel').addEventListener('click', function () { closeCalendarNewEventModal(); calendarHideForm(); });
  if ($('cal-event-delete')) $('cal-event-delete').addEventListener('click', calendarDeleteEvent);
  document.addEventListener('click', function (e) {
    var target = e.target.closest('[data-event-id]');
    if (!target) return;
    var id = target.getAttribute('data-event-id');
    if (!id) return;
    var events = getCalendarEvents();
    var ev = events.filter(function (x) { return x.id === id; })[0];
    if (ev) calendarShowForm(ev);
  });
  var monthViewEl = $('calendar-month-view');
  if (monthViewEl) {
    monthViewEl.addEventListener('click', function (e) {
      if (e.target.closest('.cal-event-dot')) return;
      var dayCell = e.target.closest('.cal-day');
      if (!dayCell) return;
      var key = dayCell.getAttribute('data-date');
      if (!key) return;
      var d = parseDateKey(key);
      if (!d) return;
      calendarState.currentDate = d;
      showCalendarView('day');
    });
  }
  var weekViewEl = $('calendar-week-view');
  if (weekViewEl) {
    weekViewEl.addEventListener('click', function (e) {
      if (e.target.closest('.cal-event-dot')) return;
      var dayCol = e.target.closest('.cal-day-col');
      if (!dayCol) return;
      var key = dayCol.getAttribute('data-date');
      if (!key) return;
      var d = parseDateKey(key);
      if (!d) return;
      calendarState.currentDate = d;
      showCalendarView('day');
    });
  }

  // --- Tasks app ---
  var tasksState = { viewMode: 'scheduled', editingTaskId: null };
  function getTasks() {
    var cfg = getDecryptedConfig();
    if (!cfg || !Array.isArray(cfg.tasks)) return [];
    return cfg.tasks;
  }
  function getTaskDateLabel(dateKey, isCompleted) {
    var todayKey = formatDateKey(new Date());
    var tomorrowKey = formatDateKey(addDays(new Date(), 1));
    var yesterdayKey = formatDateKey(addDays(new Date(), -1));
    if (dateKey === todayKey) return 'Today';
    if (dateKey === tomorrowKey) return 'Tomorrow';
    if (isCompleted && dateKey === yesterdayKey) return 'Yesterday';
    var d = parseDateKey(dateKey);
    if (!d) return dateKey;
    return d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short' });
  }
  function groupTasksByDate(tasks, isCompleted) {
    var todayKey = formatDateKey(new Date());
    var groups = [];
    var byDate = {};
    tasks.forEach(function (t) {
    var k = (t.date || '').substring(0, 10);
      if (!k) return;
      if (!byDate[k]) byDate[k] = [];
      byDate[k].push(t);
    });
    var keys = Object.keys(byDate).sort();
    if (isCompleted) keys.reverse();
    keys.forEach(function (k) {
      var list = byDate[k].slice().sort(function (a, b) {
        var t1 = (a.time || '').trim();
        var t2 = (b.time || '').trim();
        if (!t1 && !t2) return 0;
        if (!t1) return 1;
        if (!t2) return -1;
        return t1.localeCompare(t2);
      });
      groups.push({ dateKey: k, label: getTaskDateLabel(k, isCompleted), tasks: list });
    });
    return groups;
  }
  function renderTasksList() {
    var container = $('tasks-list-container');
    if (!container) return;
    var all = getTasks();
    var todayKey = formatDateKey(new Date());
    var scheduled = all.filter(function (t) {
      var k = (t.date || '').substring(0, 10);
      return k && !t.completed;
    });
    var completed = all.filter(function (t) {
      return t.completed === true;
    });
    var isCompleted = tasksState.viewMode === 'completed';
    var list = isCompleted ? completed : scheduled;
    var groups = groupTasksByDate(list, isCompleted);
    var html = '';
    groups.forEach(function (g) {
      html += '<div class="tasks-group"><div class="tasks-group-title">' + escapeHtml(g.label) + '</div><ul class="tasks-list">';
      g.tasks.forEach(function (t) {
        var pri = (t.priority || 'low');
        var completed = t.completed ? ' completed' : '';
        var completedAtStr = '';
        if (t.completed && t.completedAt) {
          try {
            var completedDate = new Date(t.completedAt);
            completedAtStr = ' <span class="task-completed-at">Completed ' + completedDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: completedDate.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined }) + '</span>';
          } catch (e) {}
        }
        html += '<li class="tasks-item' + completed + '" data-task-id="' + escapeHtml(t.id || '') + '"><input type="checkbox" class="task-checkbox" ' + (t.completed ? 'checked' : '') + ' aria-label="Complete"><span class="task-priority ' + escapeHtml(pri) + '"></span><span class="task-content">' + escapeHtml(t.title || '') + completedAtStr + '</span><span class="task-actions"><button type="button" class="btn btn-remove task-edit" data-task-id="' + escapeHtml(t.id || '') + '">Edit</button></span></li>';
      });
      html += '</ul></div>';
    });
    if (groups.length === 0) html = '<p class="help">No ' + (isCompleted ? 'completed' : 'scheduled') + ' tasks.</p>';
    container.innerHTML = html;
  }
  function tasksShowForm(task) {
    var wrap = $('tasks-form-wrap');
    var delBtn = $('task-delete');
    if (!wrap) return;
    if (task) ensureTasksFormInList();
    if (task) {
      tasksState.editingTaskId = task.id;
      if ($('task-title')) $('task-title').value = task.title || '';
      if ($('task-date')) $('task-date').value = (task.date || '').substring(0, 10) || '';
      if ($('task-priority')) $('task-priority').value = task.priority || 'low';
      var rep = task.repeat;
      var repeatVal = '';
      if (rep && typeof rep === 'object' && rep.frequency && rep.interval) repeatVal = 'custom';
      else if (rep === 'daily' || rep === 'weekly' || rep === 'biweekly' || rep === 'monthly' || rep === 'yearly') repeatVal = rep;
      if ($('task-repeat')) $('task-repeat').value = repeatVal;
      if (repeatVal === 'custom' && rep && rep.interval) {
        if ($('task-repeat-interval')) $('task-repeat-interval').value = Math.max(1, Math.min(99, parseInt(rep.interval, 10) || 1));
        if ($('task-repeat-frequency')) $('task-repeat-frequency').value = rep.frequency || 'weekly';
      }
      if ($('tasks-repeat-custom-wrap')) $('tasks-repeat-custom-wrap').style.display = repeatVal === 'custom' ? 'flex' : 'none';
      if (delBtn) delBtn.style.display = '';
    } else {
      tasksState.editingTaskId = null;
      var today = new Date();
      var key = formatDateKey(today);
      var nextQ = Math.ceil(today.getMinutes() / 15) * 15;
      var h = today.getHours();
      if (nextQ >= 60) { nextQ = 0; h += 1; }
      if (h >= 24) h = 0;
      var startTime = (h < 10 ? '0' : '') + h + ':' + (nextQ < 10 ? '0' : '') + nextQ;
      if ($('task-title')) $('task-title').value = '';
      if ($('task-date')) $('task-date').value = key;
      if ($('task-priority')) $('task-priority').value = 'low';
      if ($('task-repeat')) $('task-repeat').value = '';
      if ($('task-repeat-interval')) $('task-repeat-interval').value = '1';
      if ($('task-repeat-frequency')) $('task-repeat-frequency').value = 'weekly';
      if ($('tasks-repeat-custom-wrap')) $('tasks-repeat-custom-wrap').style.display = 'none';
      if ($('task-priority')) $('task-priority').value = 'low';
      if (delBtn) delBtn.style.display = 'none';
    }
    wrap.style.display = 'block';
  }
  function tasksHideForm() {
    var wrap = $('tasks-form-wrap');
    if (wrap) wrap.style.display = 'none';
    tasksState.editingTaskId = null;
  }
  function ensureTasksFormInList() {
    var formWrap = $('tasks-form-wrap');
    var content = $('tasks-new-task-content');
    var placeholder = $('tasks-form-placeholder');
    var modalWrap = $('tasks-new-task-wrapper');
    if (formWrap && content && placeholder && formWrap.parentElement === content) {
      placeholder.appendChild(formWrap);
      if (modalWrap) { modalWrap.classList.remove('active'); modalWrap.setAttribute('aria-hidden', 'true'); }
    }
  }
  function openTasksNewTaskModal() {
    var formWrap = $('tasks-form-wrap');
    var content = $('tasks-new-task-content');
    var placeholder = $('tasks-form-placeholder');
    var modalWrap = $('tasks-new-task-wrapper');
    if (!formWrap || !content || !placeholder || !modalWrap) return;
    content.appendChild(formWrap);
    modalWrap.classList.add('active');
    modalWrap.setAttribute('aria-hidden', 'false');
    tasksShowForm(null);
  }
  function closeTasksNewTaskModal() {
    var formWrap = $('tasks-form-wrap');
    var content = $('tasks-new-task-content');
    var placeholder = $('tasks-form-placeholder');
    var modalWrap = $('tasks-new-task-wrapper');
    if (formWrap && content && placeholder && modalWrap && formWrap.parentElement === content) {
      placeholder.appendChild(formWrap);
      modalWrap.classList.remove('active');
      modalWrap.setAttribute('aria-hidden', 'true');
    }
  }
  function taskSave() {
    var title = ($('task-title') && $('task-title').value || '').trim();
    var dateVal = ($('task-date') && $('task-date').value || '').trim().substring(0, 10);
    var timeVal = '';
    var priorityVal = ($('task-priority') && $('task-priority').value) || 'low';
    var repeatVal = ($('task-repeat') && $('task-repeat').value || '').trim();
    var repeat = null;
    if (repeatVal === 'custom') {
      var interval = Math.max(1, Math.min(99, parseInt(($('task-repeat-interval') && $('task-repeat-interval').value) || '1', 10)));
      var freq = ($('task-repeat-frequency') && $('task-repeat-frequency').value) || 'weekly';
      repeat = { frequency: freq, interval: interval };
    } else if (repeatVal) repeat = repeatVal;
    if (!title || !dateVal) return false;
    var cfg = getDecryptedConfig();
    if (!cfg) return false;
    cfg.tasks = cfg.tasks || [];
    var id = tasksState.editingTaskId;
    if (id) {
      var idx = cfg.tasks.findIndex(function (e) { return e.id === id; });
      if (idx !== -1) {
        var existing = cfg.tasks[idx];
        cfg.tasks[idx] = { id: id, title: title, date: dateVal, time: timeVal, priority: priorityVal, repeat: repeat || undefined, completed: existing.completed, completedAt: existing.completedAt, createdAt: existing.createdAt };
      }
    } else {
      var newId = Date.now() + '-' + Math.random().toString(36).slice(2, 9);
      cfg.tasks.push({ id: newId, title: title, date: dateVal, time: timeVal, priority: priorityVal, repeat: repeat || undefined, completed: false, createdAt: new Date().toISOString() });
    }
    tasksHideForm();
    renderTasksList();
    return true;
  }
  function taskDelete() {
    var id = tasksState.editingTaskId;
    if (!id) return;
    var cfg = getDecryptedConfig();
    if (cfg && Array.isArray(cfg.tasks)) cfg.tasks = cfg.tasks.filter(function (e) { return e.id !== id; });
    tasksHideForm();
    renderTasksList();
  }
  function taskToggleComplete(id) {
    var cfg = getDecryptedConfig();
    if (!cfg || !Array.isArray(cfg.tasks)) return;
    var t = cfg.tasks.find(function (e) { return e.id === id; });
    if (t) {
      t.completed = !t.completed;
      t.completedAt = t.completed ? new Date().toISOString() : undefined;
    }
    renderTasksList();
  }
  function tasksInit() {
    var cfg = getDecryptedConfig();
    if (cfg && !Array.isArray(cfg.tasks)) cfg.tasks = [];
    tasksState.viewMode = 'scheduled';
    tasksState.editingTaskId = null;
    document.querySelectorAll('.tasks-view-toggle button').forEach(function (b) {
      b.classList.toggle('active', b.id === 'tasks-view-scheduled');
    });
    renderTasksList();
  }
  if ($('tasks-view-scheduled')) $('tasks-view-scheduled').addEventListener('click', function () {
    tasksState.viewMode = 'scheduled';
    document.querySelectorAll('.tasks-view-toggle button').forEach(function (b) { b.classList.remove('active'); });
    if ($('tasks-view-scheduled')) $('tasks-view-scheduled').classList.add('active');
    renderTasksList();
  });
  if ($('tasks-view-completed')) $('tasks-view-completed').addEventListener('click', function () {
    tasksState.viewMode = 'completed';
    document.querySelectorAll('.tasks-view-toggle button').forEach(function (b) { b.classList.remove('active'); });
    if ($('tasks-view-completed')) $('tasks-view-completed').classList.add('active');
    renderTasksList();
  });
  if ($('tasks-add-btn')) $('tasks-add-btn').addEventListener('click', openTasksNewTaskModal);
  if ($('task-save')) $('task-save').addEventListener('click', function () { if (taskSave()) closeTasksNewTaskModal(); });
  if ($('task-cancel')) $('task-cancel').addEventListener('click', function () { closeTasksNewTaskModal(); tasksHideForm(); });
  if ($('task-delete')) $('task-delete').addEventListener('click', taskDelete);
  if ($('task-repeat')) $('task-repeat').addEventListener('change', function () {
    var wrap = $('tasks-repeat-custom-wrap');
    if (wrap) wrap.style.display = (this.value === 'custom') ? 'flex' : 'none';
  });
  document.addEventListener('click', function (e) {
    var editBtn = e.target.closest('.task-edit');
    if (editBtn) {
      var id = editBtn.getAttribute('data-task-id');
      if (!id) return;
      var tasks = getTasks();
      var task = tasks.find(function (t) { return t.id === id; });
      if (task) tasksShowForm(task);
      return;
    }
    var checkbox = e.target.closest('.task-checkbox');
    if (checkbox) {
      var row = e.target.closest('.tasks-item');
      if (!row) return;
      var id = row.getAttribute('data-task-id');
      if (id) taskToggleComplete(id);
    }
  });

  // --- Notes app ---
  var notesState = { selectedId: null };
  function getNotes() {
    var cfg = getDecryptedConfig();
    if (!cfg || !Array.isArray(cfg.notes)) return [];
    return cfg.notes;
  }
  function renderNotesList() {
    var list = $('notes-list');
    if (!list) return;
    var notes = getNotes().slice().sort(function (a, b) {
    var ta = (a.updatedAt || a.createdAt || '').trim();
    var tb = (b.updatedAt || b.createdAt || '').trim();
      if (!ta && !tb) return 0;
      if (!ta) return 1;
      if (!tb) return -1;
      return tb.localeCompare(ta);
    });
    var html = '';
    notes.forEach(function (note) {
      var title = (note.title || '').trim() || 'Untitled';
      var preview = (note.body || '').trim().replace(/\s+/g, ' ').slice(0, 50);
      if ((note.body || '').trim().length > 50) preview += '‚Ä¶';
      var active = note.id === notesState.selectedId ? ' active' : '';
      html += '<li><button type="button" class="notes-list-item' + active + '" data-note-id="' + escapeHtml(note.id || '') + '"><span class="notes-list-item-title">' + escapeHtml(title) + '</span>' + (preview ? '<span class="notes-list-item-preview">' + escapeHtml(preview) + '</span>' : '') + '</button></li>';
    });
    list.innerHTML = html || '<li class="help" style="padding:0.5rem;">No notes yet.</li>';
  }
  function selectNote(id) {
    notesState.selectedId = id;
    renderNotesList();
    var titleEl = $('notes-title');
    var bodyEl = $('notes-body');
    if (!titleEl || !bodyEl) return;
    if (!id) {
      titleEl.value = '';
      bodyEl.value = '';
      return;
    }
    var notes = getNotes();
    var note = notes.find(function (n) { return n.id === id; });
    if (note) {
      titleEl.value = note.title || '';
      bodyEl.value = note.body || '';
    } else {
      titleEl.value = '';
      bodyEl.value = '';
    }
  }
  function notesSave() {
    var titleEl = $('notes-title');
    var bodyEl = $('notes-body');
    if (!titleEl || !bodyEl) return;
    var title = (titleEl.value || '').trim();
    var body = (bodyEl.value || '').trim();
    var cfg = getDecryptedConfig();
    if (!cfg) return;
    cfg.notes = cfg.notes || [];
    var id = notesState.selectedId;
    var now = new Date().toISOString();
    if (id) {
      var idx = cfg.notes.findIndex(function (n) { return n.id === id; });
      if (idx !== -1) {
        cfg.notes[idx].title = title || 'Untitled';
        cfg.notes[idx].body = body;
        cfg.notes[idx].updatedAt = now;
      } else {
        id = null;
      }
    }
    if (!id) {
      id = 'note-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9);
      cfg.notes.push({ id: id, title: title || 'Untitled', body: body, createdAt: now, updatedAt: now });
    }
    notesState.selectedId = id;
    renderNotesList();
  }
  function notesDelete() {
    var id = notesState.selectedId;
    if (!id) return;
    var cfg = getDecryptedConfig();
    if (cfg && Array.isArray(cfg.notes)) cfg.notes = cfg.notes.filter(function (n) { return n.id !== id; });
    notesState.selectedId = null;
    selectNote(null);
    renderNotesList();
  }
  function notesInit() {
    var cfg = getDecryptedConfig();
    if (cfg && !Array.isArray(cfg.notes)) cfg.notes = [];
    renderNotesList();
    if (notesState.selectedId) {
      var note = getNotes().find(function (n) { return n.id === notesState.selectedId; });
      if (!note) notesState.selectedId = null;
    }
    selectNote(notesState.selectedId || null);
  }
  if ($('notes-new-btn')) $('notes-new-btn').addEventListener('click', function () { selectNote(null); if ($('notes-title')) $('notes-title').focus(); });
  if ($('notes-save-btn')) $('notes-save-btn').addEventListener('click', notesSave);
  if ($('notes-delete-btn')) $('notes-delete-btn').addEventListener('click', notesDelete);
  document.addEventListener('click', function (e) {
    var btn = e.target.closest('.notes-list-item[data-note-id]');
    if (!btn) return;
    var id = btn.getAttribute('data-note-id');
    if (id) selectNote(id);
  });

  document.querySelectorAll('.app-card[data-app]').forEach(function (card) {
    card.addEventListener('click', function () { showHomeView(card.getAttribute('data-app')); });
    card.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showHomeView(card.getAttribute('data-app')); }
    });
  });
  document.querySelectorAll('.app-sheet [data-app-back]').forEach(function (btn) {
    btn.addEventListener('click', function () {
      showHomeView('grid');
    });
  });

  var homeHeaderEl = $('home-header');
  if (homeHeaderEl) {
    homeHeaderEl.addEventListener('click', function (e) {
      var pill = e.target.closest('[data-type="event"], [data-type="task"]');
      if (!pill) return;
      var type = pill.getAttribute('data-type');
      var dateKey = pill.getAttribute('data-date');
      if (type === 'event' && dateKey) {
        showHomeView('calendar');
        var d = parseDateKey(dateKey);
        if (d) {
          calendarState.currentDate = d;
          calendarState.viewMode = 'day';
          showCalendarView('day');
        }
      } else if (type === 'task') {
        var taskId = pill.getAttribute('data-task-id');
        if (!taskId) return;
        showHomeView('tasks');
        var task = getTasks().filter(function (t) { return t.id === taskId; })[0];
        if (task) {
          ensureTasksFormInList();
          tasksShowForm(task);
        }
      }
    });
  }

  // Settings nav: switch panel
  document.querySelectorAll('.settings-nav button[data-settings-panel]').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var panelId = btn.dataset.settingsPanel;
      document.querySelectorAll('.settings-nav button[data-settings-panel]').forEach(function (b) { b.classList.remove('active'); });
      document.querySelectorAll('.settings-panel').forEach(function (p) { p.classList.remove('active'); });
      btn.classList.add('active');
      var panel = $('settings-panel-' + panelId);
      if (panel) panel.classList.add('active');
    });
  });

  function saveSettingsToConfig() {
    var repo = ($('github_repo') && $('github_repo').value || '').trim();
    var filename = ($('github_filename') && $('github_filename').value || '').trim() || 'index.html';
    var branch = ($('github_branch') && $('github_branch').value || '').trim() || 'master';
    var path = ($('github_path') && $('github_path').value || '').trim();
    if (path === '') path = '/';
    var username = ($('github_username') && $('github_username').value || '').trim();
    var token = ($('github_token') && $('github_token').value || '').trim();
    if (decryptedConfig) {
      decryptedConfig.github = { repo: repo, filename: filename, branch: branch, path: path, username: username };
    } else {
      var config = getConfig();
      if (!config.encrypted) {
        config.github = { repo: repo, filename: filename, branch: branch, path: path, username: username };
        setConfig(config);
      }
    }
    if (token && token !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') try { localStorage.setItem('honey_github_token', token); } catch (e) {}
    if ($('github_token')) $('github_token').value = token ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
  }

  function setSettingsStatus(msg, ok) {
    var el = $('settings_status');
    if (el) { el.textContent = msg; el.className = 'status' + (ok === true ? ' ok' : ok === false ? ' err' : ''); }
  }

  if ($('btn_save_locally')) {
    $('btn_save_locally').addEventListener('click', function () {
      saveSettingsToConfig();
      if (decryptedConfig && sessionPassphrase) {
        (async function () {
          try {
            var encBlob = await encryptState(decryptedConfig, sessionPassphrase);
            var cfg = getConfig();
            var blobs = (cfg.blobs || []).slice();
            if (sessionBlobIndex >= 0 && sessionBlobIndex < blobs.length) blobs[sessionBlobIndex] = encBlob;
            else blobs = [encBlob];
            setEncryptedConfig(blobs);
          } catch (e) { setSettingsStatus('Encryption failed.', false); return; }
          var tokenInput = $('github_token');
          var prevVal = tokenInput ? tokenInput.value : '';
          if (tokenInput) tokenInput.value = '';
          var html = document.documentElement.outerHTML;
          if (tokenInput) tokenInput.value = prevVal;
          var blob = new Blob([html], { type: 'text/html' });
          var a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'index.html';
          a.click();
          URL.revokeObjectURL(a.href);
          setSettingsStatus('File saved locally.', true);
        })();
        return;
      }
      var tokenInput = $('github_token');
      var prevVal = tokenInput ? tokenInput.value : '';
      if (tokenInput) tokenInput.value = '';
      var html = document.documentElement.outerHTML;
      if (tokenInput) tokenInput.value = prevVal;
      var blob = new Blob([html], { type: 'text/html' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'index.html';
      a.click();
      URL.revokeObjectURL(a.href);
      setSettingsStatus('File saved locally.', true);
    });
  }

  if ($('btn_publish')) {
    $('btn_publish').addEventListener('click', function () {
      saveSettingsToConfig();
      saveToGitHub();
    });
  }

  // Add admin: username + password, encrypt state, store in config, then show gate
  if ($('btn_add_admin')) {
    $('btn_add_admin').addEventListener('click', function () {
      passwordPrompt.show({
        serviceName: 'New admin',
        noUserName: false,
        repeatPassword: true,
        canCancel: true,
        callback: function (data) {
          if (!data) { $('admin_status').textContent = 'Cancelled.'; return true; }
          var username = (data.username || '').trim();
          if (!username) {
            $('password_prompt_status').textContent = 'Enter a username.';
            $('password_prompt_status').className = 'status err';
            return false;
          }
          if (!data.password || data.password.length < 4) {
            $('password_prompt_status').textContent = 'Password must be at least 4 characters.';
            $('password_prompt_status').className = 'status err';
            return false;
          }
          passwordPrompt.hide();
          $('admin_status').textContent = 'Adding admin‚Ä¶';
          (async function () {
            try {
              var config = getConfig();
              if (decryptedConfig) {
                decryptedConfig.admins = decryptedConfig.admins || [];
                decryptedConfig.admins.push(username);
                var newBlob = await encryptState(decryptedConfig, data.password);
                var config = getConfig();
                var blobs = (config.blobs || []).slice();
                blobs.push(newBlob);
                setEncryptedConfig(blobs);
                $('admin_status').textContent = 'Admin added. They can unlock with this username and the password you just entered.';
                $('admin_status').className = 'status ok';
                return;
              }
              if (!hasAnyAdmin(config)) {
                var g = config.github || { repo: '', filename: 'index.html', branch: 'master', path: '/', username: '' };
                var payload = { github: g, admins: [username] };
                var appDefaults = getDefaultAppData();
                Object.keys(appDefaults).forEach(function (k) { payload[k] = appDefaults[k]; });
                var blob = await encryptState(payload, data.password);
                setEncryptedConfig(blob);
                sessionPassphrase = data.password;
                decryptedConfig = ensureAppDataInConfig(payload);
                $('admin_status').textContent = 'Admin added. All settings are now encrypted. Unlock with this username and password.';
                $('admin_status').className = 'status ok';
                updateAdminSection();
                showScreen('screen-gate');
                return;
              }
              var state = { username: username };
              var blob = await encryptState(state, data.password);
              config.encryptionEnabled = true;
              var entry = { salt: blob.salt, iv: blob.iv, ciphertext: blob.ciphertext };
              if (config.admins && config.admins.length) {
                config.admins.push(entry);
              } else if (config.admin && config.admin.salt && config.admin.iv && config.admin.ciphertext) {
                config.admins = [config.admin, entry];
                config.admin = null;
              } else {
                config.admins = [entry];
                config.admin = null;
              }
              setConfig(config);
              $('admin_status').textContent = 'Admin added. You can add more admins or unlock with this username and password.';
              $('admin_status').className = 'status ok';
              updateAdminSection();
              showScreen('screen-gate');
            } catch (e) {
              $('admin_status').textContent = 'Error: ' + (e.message || e);
              $('admin_status').className = 'status err';
            }
          })();
          return true;
        }
      });
    });
  }

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(function (s) { s.classList.remove('active'); });
    var el = $(id);
    if (el) el.classList.add('active');
  }

  function showHomeTab() {
    showHomeView('grid');
  }

  // Unlock: verify username + password, decrypt, show app (supports encrypted blob-only format and legacy)
  async function doUnlock() {
    var username = ($('unlock_username') && $('unlock_username').value || '').trim();
    var password = $('unlock_password') ? $('unlock_password').value : '';
    if (!username || !password) {
      $('gate_status').textContent = 'Enter username and password.';
      $('gate_status').className = 'status err';
      return;
    }
    var config = getConfig();
    if (config.encrypted) {
      var blobs = config.blobs || [];
      for (var i = 0; i < blobs.length; i++) {
        try {
          var decrypted = await decryptState(blobs[i], password);
          var admins = decrypted && decrypted.admins;
          if (admins && admins.indexOf(username) !== -1) {
            decryptedConfig = ensureAppDataInConfig(decrypted);
            sessionPassphrase = password;
            sessionBlobIndex = i;
            if ($('unlock_keep_session') && $('unlock_keep_session').checked) {
              try {
                sessionStorage.setItem('honey_session_username', username);
                sessionStorage.setItem('honey_session_passphrase', password);
                sessionStorage.setItem('honey_session_blob_index', String(i));
                sessionStorage.setItem('honey_session_encrypted', '1');
              } catch (err) {}
            } else {
              try { sessionStorage.removeItem('honey_session_username'); sessionStorage.removeItem('honey_session_passphrase'); sessionStorage.removeItem('honey_session_blob_index'); sessionStorage.removeItem('honey_session_encrypted'); } catch (err) {}
            }
            loadConfigIntoForm();
            loadTokenIntoForm();
            updateAdminSection();
            $('gate_status').textContent = '';
            $('unlock_password').value = '';
            tryShowAppOrTokenGate();
            return;
          }
        } catch (e) {}
      }
      $('gate_status').textContent = 'Wrong username or password.';
      $('gate_status').className = 'status err';
      return;
    }
    var list = getAdminList(config);
    if (!config.encryptionEnabled || list.length === 0) {
      $('gate_status').textContent = 'No admin set.';
      $('gate_status').className = 'status err';
      return;
    }
    var oldFormatSingle = list.length === 1 && list[0].username != null && list[0].passwordHash != null;
    if (oldFormatSingle) {
      var admin = list[0];
      if (admin.username !== username) {
        $('gate_status').textContent = 'Wrong username or password.';
        $('gate_status').className = 'status err';
        return;
      }
      var hashHex = await sha256Hex(password);
      if (hashHex !== admin.passwordHash) {
        $('gate_status').textContent = 'Wrong username or password.';
        $('gate_status').className = 'status err';
        return;
      }
      var blob = { salt: admin.salt, iv: admin.iv, ciphertext: admin.ciphertext };
      try {
        await decryptState(blob, password);
        if ($('unlock_keep_session') && $('unlock_keep_session').checked) {
          try {
            sessionStorage.setItem('honey_session_username', username);
            sessionStorage.setItem('honey_session_passphrase', password);
            sessionStorage.setItem('honey_session_blob_index', '0');
            sessionStorage.setItem('honey_session_encrypted', '0');
          } catch (err) {}
        } else {
          try { sessionStorage.removeItem('honey_session_username'); sessionStorage.removeItem('honey_session_passphrase'); sessionStorage.removeItem('honey_session_blob_index'); sessionStorage.removeItem('honey_session_encrypted'); } catch (err) {}
        }
        loadConfigIntoForm();
        loadTokenIntoForm();
        updateAdminSection();
        $('gate_status').textContent = '';
        $('unlock_password').value = '';
        tryShowAppOrTokenGate();
      } catch (e) {
        $('gate_status').textContent = 'Wrong username or password.';
        $('gate_status').className = 'status err';
      }
      return;
    }
    for (var i = 0; i < list.length; i++) {
      var b = list[i];
      if (!b.salt || !b.iv || !b.ciphertext) continue;
      try {
        var decrypted = await decryptState(b, password);
        var decryptedUsername = decrypted && decrypted.username;
        if (decryptedUsername != null && decryptedUsername === username) {
          if ($('unlock_keep_session') && $('unlock_keep_session').checked) {
            try {
              sessionStorage.setItem('honey_session_username', username);
              sessionStorage.setItem('honey_session_passphrase', password);
              sessionStorage.setItem('honey_session_blob_index', String(i));
              sessionStorage.setItem('honey_session_encrypted', '1');
            } catch (err) {}
          } else {
            try { sessionStorage.removeItem('honey_session_username'); sessionStorage.removeItem('honey_session_passphrase'); sessionStorage.removeItem('honey_session_blob_index'); sessionStorage.removeItem('honey_session_encrypted'); } catch (err) {}
          }
          loadConfigIntoForm();
          loadTokenIntoForm();
          updateAdminSection();
          $('gate_status').textContent = '';
          $('unlock_password').value = '';
          tryShowAppOrTokenGate();
          return;
        }
      } catch (e) {}
    }
    $('gate_status').textContent = 'Wrong username or password.';
    $('gate_status').className = 'status err';
  }

  async function tryRestoreSession() {
    var config = getConfig();
    if (!config.encrypted && !(config.encryptionEnabled && hasAnyAdmin(config))) return false;
    try {
      var username = sessionStorage.getItem('honey_session_username');
      var passphrase = sessionStorage.getItem('honey_session_passphrase');
      var blobIndexStr = sessionStorage.getItem('honey_session_blob_index');
      var encrypted = sessionStorage.getItem('honey_session_encrypted');
      if (!username || !passphrase) return false;
      if (config.encrypted) {
        var blobs = config.blobs || [];
        var i = blobIndexStr !== null ? parseInt(blobIndexStr, 10) : 0;
        if (i < 0 || i >= blobs.length) return false;
        var decrypted = await decryptState(blobs[i], passphrase);
        var admins = decrypted && decrypted.admins;
        if (!admins || admins.indexOf(username) === -1) return false;
        decryptedConfig = ensureAppDataInConfig(decrypted);
        sessionPassphrase = passphrase;
        sessionBlobIndex = i;
        loadConfigIntoForm();
        loadTokenIntoForm();
        updateAdminSection();
        tryShowAppOrTokenGate();
        return true;
      }
      var list = getAdminList(config);
      for (var j = 0; j < list.length; j++) {
        var b = list[j];
        if (!b.salt || !b.iv || !b.ciphertext) continue;
        try {
          var dec = await decryptState(b, passphrase);
          if (dec && dec.username === username) {
            loadConfigIntoForm();
            loadTokenIntoForm();
            updateAdminSection();
            tryShowAppOrTokenGate();
            return true;
          }
        } catch (e) {}
      }
      return false;
    } catch (e) { return false; }
  }

  if ($('token_gate_form')) {
    $('token_gate_form').addEventListener('submit', function (e) {
      e.preventDefault();
      var input = $('token_gate_input');
      var token = (input && input.value || '').trim();
      if (!token) {
        if ($('token_gate_status')) { $('token_gate_status').textContent = 'Enter a token.'; $('token_gate_status').className = 'status err'; }
        return;
      }
      if ($('token_gate_status')) { $('token_gate_status').textContent = 'Checking token‚Ä¶'; $('token_gate_status').className = 'status'; }
      validateGitHubToken(token).then(function (result) {
        if (result.ok) {
          try { localStorage.setItem('honey_github_token', token); } catch (err) {}
          if (input) input.value = '';
          if ($('token_gate_status')) { $('token_gate_status').textContent = ''; $('token_gate_status').className = 'status'; }
          loadTokenIntoForm();
          showScreen('screen-app');
          showHomeTab();
        } else {
          if ($('token_gate_status')) { $('token_gate_status').textContent = result.message; $('token_gate_status').className = 'status err'; }
        }
      });
    });
  }

  if ($('unlock_form')) {
    $('unlock_form').addEventListener('submit', function (e) {
      e.preventDefault();
      doUnlock();
    });
  }

  // Load token from localStorage into form (masked)
  function loadTokenIntoForm() {
    try {
      var t = localStorage.getItem('honey_github_token');
      if (t && $('github_token')) $('github_token').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    } catch (e) {}
  }

  loadConfigIntoForm();
  loadTokenIntoForm();

  function updateAdminSection() {
    var config = getConfig();
    var hasAdmins = config.encrypted ? (decryptedConfig && decryptedConfig.admins && decryptedConfig.admins.length) : hasAnyAdmin(config);
    if ($('btn_add_admin')) $('btn_add_admin').style.display = '';
    if ($('admin_help')) $('admin_help').style.display = hasAdmins ? 'none' : 'block';
    if ($('admin_locked_msg')) $('admin_locked_msg').style.display = hasAdmins ? 'block' : 'none';
    var listEl = $('admin_list');
    var wrapperEl = $('admin_table_wrapper');
    if (listEl && wrapperEl) {
      var items = [];
      if (decryptedConfig && decryptedConfig.admins && decryptedConfig.admins.length) {
        decryptedConfig.admins.forEach(function (n) { items.push({ name: n, username: n }); });
      } else if (!config.encrypted) {
        var list = getAdminList(config);
        for (var i = 0; i < list.length; i++) {
          var label = list[i].username ? list[i].username : 'Admin ' + (i + 1);
          items.push({ name: label, index: i });
        }
      }
      wrapperEl.style.display = 'block';
      if (items.length) {
        listEl.innerHTML = items.map(function (item) {
          var removeAttr = item.username != null
            ? ' data-remove-username="' + escapeHtml(item.username) + '"'
            : ' data-remove-index="' + item.index + '"';
          var resetBtn = item.username != null
            ? '<button type="button" class="btn secondary btn-secondary-small" data-reset-username="' + escapeHtml(item.username) + '">Reset password</button>'
            : '<span class="admin-table-muted">‚Äî</span>';
          return '<tr><td>' + escapeHtml(item.name) + '</td><td>' + resetBtn + '</td><td><button type="button" class="btn secondary btn-secondary-small"' + removeAttr + '>Remove</button></td></tr>';
        }).join('');
      } else {
        listEl.innerHTML = '<tr><td colspan="3">No admins</td></tr>';
      }
    }
  }

  function removeAdmin(identifier) {
    var config = getConfig();
    if (config.encrypted && decryptedConfig) {
      var j = typeof identifier === 'string' ? decryptedConfig.admins.indexOf(identifier) : identifier;
      if (j < 0) return;
      decryptedConfig.admins.splice(j, 1);
      if (!decryptedConfig.admins.length) {
        var legacy = { github: decryptedConfig.github || { repo: '', filename: 'index.html', branch: 'master', path: '/', username: '' }, encryptionEnabled: false, admin: null, admins: [] };
        setConfig(legacy);
        decryptedConfig = null;
        sessionPassphrase = null;
        sessionBlobIndex = -1;
        loadConfigIntoForm();
        updateAdminSection();
        if ($('admin_status')) { $('admin_status').textContent = 'All admins removed. Encryption is off.'; $('admin_status').className = 'status ok'; setTimeout(function () { var a = $('admin_status'); if (a) a.textContent = ''; }, 3000); }
        return;
      }
      var blobs = (config.blobs || []).slice();
      blobs.splice(j, 1);
      if (j === sessionBlobIndex) {
        setEncryptedConfig(blobs);
        decryptedConfig = null;
        sessionPassphrase = null;
        sessionBlobIndex = -1;
        updateAdminSection();
        showScreen('screen-gate');
        if ($('admin_status')) { $('admin_status').textContent = 'You removed yourself. Unlock with another admin.'; $('admin_status').className = 'status ok'; setTimeout(function () { var a = $('admin_status'); if (a) a.textContent = ''; }, 3000); }
        return;
      }
      if (j < sessionBlobIndex) sessionBlobIndex--;
      (async function () {
        try {
          var blob = await encryptState(decryptedConfig, sessionPassphrase);
          blobs[sessionBlobIndex] = blob;
          setEncryptedConfig(blobs);
          updateAdminSection();
          if ($('admin_status')) { $('admin_status').textContent = 'Admin removed.'; $('admin_status').className = 'status ok'; setTimeout(function () { var a = $('admin_status'); if (a) a.textContent = ''; }, 3000); }
        } catch (e) {
          if ($('admin_status')) { $('admin_status').textContent = 'Error: ' + (e.message || e); $('admin_status').className = 'status err'; setTimeout(function () { var a = $('admin_status'); if (a) a.textContent = ''; }, 3000); }
        }
      })();
      return;
    }
    if (!config.encrypted) {
      var list = getAdminList(config);
      var idx = typeof identifier === 'number' ? identifier : list.findIndex(function (a) { return a.username === identifier; });
      if (idx < 0) return;
      if (config.admins && config.admins.length) {
        config.admins.splice(idx, 1);
        if (config.admins.length === 0) { config.admin = null; config.encryptionEnabled = false; }
      } else if (config.admin) {
        config.admin = null;
        config.encryptionEnabled = false;
      }
      setConfig(config);
      updateAdminSection();
      if ($('admin_status')) { $('admin_status').textContent = 'Admin removed.'; $('admin_status').className = 'status ok'; setTimeout(function () { var a = $('admin_status'); if (a) a.textContent = ''; }, 3000); }
    }
  }

  function escapeHtml(s) {
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  if ($('admin_list')) {
    $('admin_list').addEventListener('click', function (e) {
      var target = e.target && e.target.closest && e.target.closest('button');
      if (!target) return;
      var removeBtn = target.closest('button[data-remove-username], button[data-remove-index]');
      var resetBtn = target.closest('button[data-reset-username]');
      if (resetBtn) {
        var username = resetBtn.getAttribute('data-reset-username');
        if (username) resetAdminPassword(username);
        return;
      }
      if (removeBtn) {
        var username = removeBtn.getAttribute('data-remove-username');
        var indexStr = removeBtn.getAttribute('data-remove-index');
        var label = username != null ? username : ('Admin #' + (indexStr != null ? parseInt(indexStr, 10) + 1 : ''));
        if (!confirm('Are you sure you want to remove ' + label + '?')) return;
        if (username != null) removeAdmin(username);
        else if (indexStr != null) removeAdmin(parseInt(indexStr, 10));
      }
    });
  }

  function resetAdminPassword(username) {
    if (!decryptedConfig || !decryptedConfig.admins || decryptedConfig.admins.indexOf(username) === -1) return;
    var blobIndex = decryptedConfig.admins.indexOf(username);
    passwordPrompt.show({
      serviceName: 'Reset password for ' + username,
      noUserName: true,
      repeatPassword: true,
      canCancel: true,
      callback: function (data) {
        if (!data) { if ($('admin_status')) $('admin_status').textContent = 'Cancelled.'; return true; }
        if (!data.password || data.password.length < 4) {
          $('password_prompt_status').textContent = 'Password must be at least 4 characters.';
          $('password_prompt_status').className = 'status err';
          return false;
        }
        passwordPrompt.hide();
        (async function () {
          try {
            var newBlob = await encryptState(decryptedConfig, data.password);
            var config = getConfig();
            var blobs = (config.blobs || []).slice();
            blobs[blobIndex] = newBlob;
            setEncryptedConfig(blobs);
            updateAdminSection();
            if ($('admin_status')) { $('admin_status').textContent = 'Password updated for ' + username + '.'; $('admin_status').className = 'status ok'; setTimeout(function () { var a = $('admin_status'); if (a) a.textContent = ''; }, 3000); }
          } catch (e) {
            if ($('admin_status')) { $('admin_status').textContent = 'Error: ' + (e.message || e); $('admin_status').className = 'status err'; setTimeout(function () { var a = $('admin_status'); if (a) a.textContent = ''; }, 3000); }
          }
        })();
        return true;
      }
    });
  }

  // Init: try session restore, else show gate if encrypted or token gate then app
  (function init() {
    var config = getConfig();
    updateAdminSection();
    if (config.encrypted || (config.encryptionEnabled && hasAnyAdmin(config))) {
      tryRestoreSession().then(function (restored) {
        if (!restored) showScreen('screen-gate');
      });
    } else {
      tryShowAppOrTokenGate();
    }
  })();
})();
  </script>


<div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 678px !important; left: 402px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 678px !important; left: 402px !important; opacity: 0 !important; visibility: hidden !important;"></div><!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
<div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 0px !important; left: 0px !important; opacity: 0 !important; visibility: hidden !important; height: 69.5px !important; width: 305px !important;"></div><!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
<div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 263px !important; left: 247px !important; opacity: 1 !important; visibility: visible !important; height: 69.5px !important; width: 305px !important;"></div><!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
<div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
<div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 0px !important; left: 0px !important; opacity: 0 !important; visibility: hidden !important; height: 69.5px !important; width: 305px !important;"></div><!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
<div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 0px !important; left: 0px !important; opacity: 0 !important; visibility: hidden !important; height: 69.5px !important; width: 305px !important;"></div><!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
<div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 0px !important; left: 0px !important; opacity: 0 !important; visibility: hidden !important; height: 69.5px !important; width: 305px !important;"></div><!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
<div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 0px !important; left: 0px !important; opacity: 0 !important; visibility: hidden !important; height: 69.5px !important; width: 305px !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div><div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 190px !important; left: 247px !important; opacity: 0 !important; visibility: hidden !important;"></div></body></html>